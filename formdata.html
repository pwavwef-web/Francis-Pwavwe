<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Certificate Orders ‚Äî Admin View</title>
  <link rel="icon" type="image/png" href="favicon.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --rose:     #c0392b;
      --crimson:  #8b0000;
      --blush:    #fde8ec;
      --pink:     #f9c4ce;
      --gold:     #c9973a;
      --white:    #ffffff;
      --off-white:#fdf6f7;
      --text-dark:#2d0b0e;
      --text-mid: #6b2737;
      --text-light:#9c4a59;
      --shadow:   0 8px 40px rgba(139,0,0,0.14);
    }

    body {
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      background: linear-gradient(160deg, #3b0010 0%, #6b1224 40%, #a0293d 100%);
      color: var(--text-dark);
    }

    /* ‚îÄ‚îÄ Login screen ‚îÄ‚îÄ */
    .login-wrap {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem 1rem;
    }
    .login-card {
      background: rgba(255,255,255,0.95);
      border-radius: 18px;
      padding: 2.5rem 2rem;
      max-width: 420px;
      width: 100%;
      box-shadow: var(--shadow);
      text-align: center;
    }
    .login-card .icon { font-size: 3.5rem; margin-bottom: 0.75rem; }
    .login-card h1 {
      font-family: 'Playfair Display', serif;
      font-size: 1.6rem;
      color: var(--crimson);
      margin-bottom: 0.5rem;
    }
    .login-card p {
      font-size: 0.9rem;
      color: var(--text-light);
      margin-bottom: 1.75rem;
      line-height: 1.6;
    }
    .btn-google {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      width: 100%;
      padding: 0.9rem;
      background: var(--white);
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-family: 'Inter', sans-serif;
      font-size: 0.97rem;
      font-weight: 600;
      color: #444;
      cursor: pointer;
      transition: 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .btn-google:hover { border-color: var(--rose); color: var(--rose); box-shadow: 0 4px 16px rgba(192,57,43,0.12); }
    .btn-google svg { width: 20px; height: 20px; flex-shrink: 0; }
    .login-alert {
      margin-top: 1rem;
      font-size: 0.85rem;
      color: #b71c1c;
      background: #fde8e8;
      border-radius: 6px;
      padding: 0.6rem 0.9rem;
      display: none;
    }
    .login-alert.show { display: block; }

    /* ‚îÄ‚îÄ Main app (hidden until logged in) ‚îÄ‚îÄ */
    #app {
      display: none;
      min-height: 100vh;
    }
    #app.active { display: block; }

    /* ‚îÄ‚îÄ Top bar ‚îÄ‚îÄ */
    .topbar {
      background: rgba(10,0,3,0.6);
      backdrop-filter: blur(12px);
      position: sticky;
      top: 0;
      z-index: 100;
      padding: 0.9rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }
    .topbar-brand {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      color: var(--white);
    }
    .topbar-brand .heart { font-size: 1.3rem; }
    .topbar-brand h2 {
      font-family: 'Playfair Display', serif;
      font-size: 1.15rem;
      font-weight: 700;
      color: var(--white);
    }
    .topbar-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .topbar-user {
      font-size: 0.82rem;
      color: rgba(255,255,255,0.7);
    }
    .btn-signout {
      background: rgba(255,255,255,0.12);
      color: var(--white);
      border: 1px solid rgba(255,255,255,0.25);
      border-radius: 6px;
      padding: 0.4rem 0.9rem;
      font-family: 'Inter', sans-serif;
      font-size: 0.83rem;
      cursor: pointer;
      transition: 0.2s;
    }
    .btn-signout:hover { background: rgba(255,255,255,0.22); }

    /* ‚îÄ‚îÄ Content wrapper ‚îÄ‚îÄ */
    .content-wrap {
      max-width: 1000px;
      margin: 0 auto;
      padding: 2rem 1.25rem 4rem;
    }

    /* ‚îÄ‚îÄ Stats row ‚îÄ‚îÄ */
    .stats-row {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 1.75rem;
    }
    .stat-card {
      background: rgba(255,255,255,0.92);
      border-radius: 12px;
      padding: 1.25rem 1.5rem;
      flex: 1;
      min-width: 140px;
      box-shadow: 0 4px 20px rgba(139,0,0,0.1);
      text-align: center;
    }
    .stat-card .num {
      font-family: 'Playfair Display', serif;
      font-size: 2rem;
      font-weight: 700;
      color: var(--crimson);
      line-height: 1;
    }
    .stat-card .label {
      font-size: 0.78rem;
      color: var(--text-light);
      margin-top: 0.3rem;
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }

    /* ‚îÄ‚îÄ Toolbar ‚îÄ‚îÄ */
    .toolbar {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 1.25rem;
    }
    .search-box {
      flex: 1;
      min-width: 180px;
      padding: 0.7rem 1rem;
      border: 2px solid var(--pink);
      border-radius: 8px;
      font-family: 'Inter', sans-serif;
      font-size: 0.93rem;
      background: rgba(255,255,255,0.95);
      color: var(--text-dark);
      transition: 0.2s;
    }
    .search-box:focus { outline: none; border-color: var(--rose); box-shadow: 0 0 0 3px rgba(192,57,43,0.12); }
    .filter-select {
      padding: 0.7rem 1rem;
      border: 2px solid var(--pink);
      border-radius: 8px;
      font-family: 'Inter', sans-serif;
      font-size: 0.88rem;
      background: rgba(255,255,255,0.95);
      color: var(--text-dark);
      cursor: pointer;
      transition: 0.2s;
    }
    .filter-select:focus { outline: none; border-color: var(--rose); }
    .btn-export {
      padding: 0.7rem 1.25rem;
      background: linear-gradient(135deg, var(--rose), var(--crimson));
      color: var(--white);
      border: none;
      border-radius: 8px;
      font-family: 'Inter', sans-serif;
      font-size: 0.88rem;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s;
      white-space: nowrap;
    }
    .btn-export:hover { opacity: 0.88; }

    /* ‚îÄ‚îÄ Table card ‚îÄ‚îÄ */
    .table-card {
      background: rgba(255,255,255,0.95);
      border-radius: 14px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .table-card h3 {
      font-family: 'Playfair Display', serif;
      font-size: 1.1rem;
      color: var(--crimson);
      padding: 1.25rem 1.5rem 0;
      margin-bottom: 0;
    }
    .table-wrap { overflow-x: auto; }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.88rem;
    }
    thead th {
      background: #f7e8ec;
      color: var(--crimson);
      font-weight: 700;
      text-align: left;
      padding: 0.85rem 1rem;
      border-bottom: 2px solid var(--pink);
      white-space: nowrap;
      cursor: pointer;
      user-select: none;
    }
    thead th:hover { background: #f0d0d8; }
    thead th .sort-icon { margin-left: 4px; opacity: 0.5; font-size: 0.75rem; }
    tbody tr { transition: background 0.15s; }
    tbody tr:nth-child(even) { background: #fdf0f3; }
    tbody tr:hover { background: #fce4ea; }
    tbody td {
      padding: 0.85rem 1rem;
      border-bottom: 1px solid #f5dde3;
      color: var(--text-dark);
      vertical-align: middle;
    }
    tbody td.muted { color: var(--text-light); font-size: 0.8rem; }
    .badge {
      display: inline-block;
      background: var(--blush);
      color: var(--crimson);
      border: 1px solid var(--pink);
      border-radius: 50px;
      padding: 0.2rem 0.65rem;
      font-size: 0.78rem;
      font-weight: 600;
      white-space: nowrap;
    }
    .ref-cell {
      font-family: monospace;
      font-size: 0.78rem;
      color: var(--text-light);
      word-break: break-all;
    }

    /* ‚îÄ‚îÄ Empty / loading states ‚îÄ‚îÄ */
    .state-row td {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-light);
      font-size: 0.93rem;
    }
    .spinner-wrap {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.6rem;
    }
    .spinner {
      width: 20px;
      height: 20px;
      border: 2.5px solid var(--pink);
      border-top-color: var(--rose);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
    @media (max-width: 600px) {
      .topbar { padding: 0.75rem 1rem; }
      .content-wrap { padding: 1.25rem 0.75rem 3rem; }
      thead th, tbody td { padding: 0.65rem 0.65rem; font-size: 0.8rem; }
    }
  </style>
</head>
<body>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="login-wrap" id="loginWrap">
  <div class="login-card">
    <div class="icon">üåπ</div>
    <h1>Admin Access</h1>
    <p>This page is restricted to the site owner.<br />Sign in with <strong>pwavwef@gmail.com</strong> to view certificate orders.</p>
    <button class="btn-google" id="googleSignInBtn">
      <!-- Google "G" icon -->
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
        <path fill="#EA4335" d="M24 9.5c3.1 0 5.8 1.1 7.9 2.9l5.9-5.9C34.3 3.3 29.4 1 24 1 14.7 1 6.8 6.7 3.3 14.7l6.9 5.4C12 13.4 17.5 9.5 24 9.5z"/>
        <path fill="#4285F4" d="M46.5 24.5c0-1.6-.1-3.1-.4-4.5H24v8.5h12.7c-.6 3-2.3 5.5-4.8 7.2l7.4 5.8C43.6 37.3 46.5 31.3 46.5 24.5z"/>
        <path fill="#FBBC05" d="M10.2 28.5c-.6-1.8-1-3.6-1-5.5s.3-3.8 1-5.5L3.3 12C1.2 16 0 20.4 0 25s1.2 9 3.3 13l6.9-5.5z"/>
        <path fill="#34A853" d="M24 47c5.4 0 10-1.8 13.3-4.8l-7.4-5.8c-2 1.3-4.5 2.1-7 2.1-6.5 0-12-3.9-14.3-9.5L3.3 34.5C6.8 42.3 14.7 47 24 47z"/>
      </svg>
      Sign in with Google
    </button>
    <div class="login-alert" id="loginAlert"></div>
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ APP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="app">
  <nav class="topbar">
    <div class="topbar-brand">
      <span class="heart">üíù</span>
      <h2>Midnight in Love ‚Äî Certificate Orders</h2>
    </div>
    <div class="topbar-right">
      <span class="topbar-user" id="userEmail"></span>
      <button class="btn-signout" id="signOutBtn">Sign Out</button>
    </div>
  </nav>

  <div class="content-wrap">

    <!-- Stats -->
    <div class="stats-row">
      <div class="stat-card">
        <div class="num" id="statTotal">‚Äî</div>
        <div class="label">Total Orders</div>
      </div>
      <div class="stat-card">
        <div class="num" id="statCommittees">‚Äî</div>
        <div class="label">Committees</div>
      </div>
      <div class="stat-card">
        <div class="num" id="statAmount">‚Äî</div>
        <div class="label">Total Collected (GHS)</div>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <input type="text" class="search-box" id="searchBox" placeholder="üîç Search by name, committee, email‚Ä¶" />
      <select class="filter-select" id="committeeFilter">
        <option value="">All Committees</option>
      </select>
      <button class="btn-export" id="exportBtn">‚¨áÔ∏è Export CSV</button>
    </div>

    <!-- Table -->
    <div class="table-card">
      <h3>üìã Submissions (sorted A‚ÄìZ by name)</h3>
      <div class="table-wrap">
        <table id="ordersTable">
          <thead>
            <tr>
              <th data-col="idx">#</th>
              <th data-col="name">Name ‚Üï</th>
              <th data-col="committee">Committee ‚Üï</th>
              <th data-col="email">Email</th>
              <th data-col="phone">Phone</th>
              <th data-col="paymentRef">Payment Ref</th>
              <th data-col="timestamp">Date &amp; Time ‚Üï</th>
            </tr>
          </thead>
          <tbody id="ordersBody">
            <tr class="state-row">
              <td colspan="7">
                <div class="spinner-wrap"><div class="spinner"></div> Loading orders‚Ä¶</div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp }
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged }
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, collection, query, orderBy, getDocs }
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey:            "AIzaSyB6lxgjNY4CRNHAe3pAgR5SYv1ohL8brOI",
    authDomain:        "francis-pwavwe.firebaseapp.com",
    projectId:         "francis-pwavwe",
    storageBucket:     "francis-pwavwe.firebasestorage.app",
    messagingSenderId: "658069378543",
    appId:             "1:658069378543:web:87b1dcb0dd27d3255bd21a"
  };
  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  const ALLOWED_EMAIL = 'pwavwef@gmail.com';

  /* ‚îÄ‚îÄ Auth state ‚îÄ‚îÄ */
  onAuthStateChanged(auth, async user => {
    if (user && user.email === ALLOWED_EMAIL) {
      showApp(user);
      await loadOrders();
    } else {
      if (user) {
        // Wrong account
        await signOut(auth);
        showLoginAlert('Access denied. Please sign in with pwavwef@gmail.com.');
      }
      showLogin();
    }
  });

  function showLogin() {
    document.getElementById('loginWrap').style.display = 'flex';
    document.getElementById('app').classList.remove('active');
  }
  function showApp(user) {
    document.getElementById('loginWrap').style.display = 'none';
    document.getElementById('app').classList.add('active');
    document.getElementById('userEmail').textContent = user.email;
  }
  function showLoginAlert(msg) {
    const el = document.getElementById('loginAlert');
    el.textContent = msg;
    el.classList.add('show');
  }

  /* ‚îÄ‚îÄ Sign in ‚îÄ‚îÄ */
  document.getElementById('googleSignInBtn').addEventListener('click', async () => {
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ login_hint: ALLOWED_EMAIL });
    try {
      await signInWithPopup(auth, provider);
    } catch(err) {
      showLoginAlert('Sign-in failed: ' + err.message);
    }
  });

  /* ‚îÄ‚îÄ Sign out ‚îÄ‚îÄ */
  document.getElementById('signOutBtn').addEventListener('click', () => signOut(auth));

  /* ‚îÄ‚îÄ Data ‚îÄ‚îÄ */
  let allOrders = [];

  async function loadOrders() {
    try {
      const snap = await getDocs(query(collection(db, 'certificateOrders'), orderBy('timestamp', 'asc')));
      allOrders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      populateCommitteeFilter(allOrders);
      renderTable(allOrders);
      renderStats(allOrders);
    } catch(err) {
      console.error(err);
      document.getElementById('ordersBody').innerHTML =
        `<tr class="state-row"><td colspan="7">‚ö†Ô∏è Could not load orders: ${err.message}</td></tr>`;
    }
  }

  /* ‚îÄ‚îÄ Stats ‚îÄ‚îÄ */
  function renderStats(data) {
    document.getElementById('statTotal').textContent = data.length;
    const committees = new Set(data.map(o => o.committee).filter(Boolean));
    document.getElementById('statCommittees').textContent = committees.size;
    document.getElementById('statAmount').textContent = (data.length * 6).toFixed(2);
  }

  /* ‚îÄ‚îÄ Filter dropdown ‚îÄ‚îÄ */
  function populateCommitteeFilter(data) {
    const committees = [...new Set(data.map(o => o.committee).filter(Boolean))].sort();
    const sel = document.getElementById('committeeFilter');
    committees.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c;
      opt.textContent = c;
      sel.appendChild(opt);
    });
  }

  /* ‚îÄ‚îÄ Render table ‚îÄ‚îÄ */
  function renderTable(data) {
    const sorted = [...data].sort((a, b) =>
      (a.name || '').localeCompare(b.name || '', undefined, { sensitivity: 'base' })
    );

    const body = document.getElementById('ordersBody');
    if (!sorted.length) {
      body.innerHTML = '<tr class="state-row"><td colspan="7">No orders found.</td></tr>';
      return;
    }

    body.innerHTML = sorted.map((o, i) => {
      const ts = o.timestamp?.toDate ? o.timestamp.toDate() : null;
      const dateStr = ts ? ts.toLocaleString('en-GH', { dateStyle: 'medium', timeStyle: 'short' }) : '‚Äî';
      return `
        <tr>
          <td class="muted">${i + 1}</td>
          <td><strong>${esc(o.name || '‚Äî')}</strong></td>
          <td><span class="badge">${esc(o.committee || '‚Äî')}</span></td>
          <td class="muted">${esc(o.email || '‚Äî')}</td>
          <td class="muted">${esc(o.phone || '‚Äî')}</td>
          <td class="ref-cell">${esc(o.paymentRef || '‚Äî')}</td>
          <td class="muted">${dateStr}</td>
        </tr>`;
    }).join('');
  }

  /* ‚îÄ‚îÄ Search & filter ‚îÄ‚îÄ */
  function getFiltered() {
    const q  = document.getElementById('searchBox').value.trim().toLowerCase();
    const cf = document.getElementById('committeeFilter').value;
    return allOrders.filter(o => {
      const matchesSearch = !q ||
        (o.name      || '').toLowerCase().includes(q) ||
        (o.committee || '').toLowerCase().includes(q) ||
        (o.email     || '').toLowerCase().includes(q);
      const matchesFilter = !cf || o.committee === cf;
      return matchesSearch && matchesFilter;
    });
  }

  document.getElementById('searchBox').addEventListener('input', () => {
    const filtered = getFiltered();
    renderTable(filtered);
    renderStats(filtered);
  });
  document.getElementById('committeeFilter').addEventListener('change', () => {
    const filtered = getFiltered();
    renderTable(filtered);
    renderStats(filtered);
  });

  /* ‚îÄ‚îÄ CSV Export ‚îÄ‚îÄ */
  document.getElementById('exportBtn').addEventListener('click', () => {
    const filtered = getFiltered();
    const sorted   = [...filtered].sort((a, b) =>
      (a.name || '').localeCompare(b.name || '', undefined, { sensitivity: 'base' })
    );
    const rows = [
      ['#', 'Name', 'Committee', 'Email', 'Phone', 'Payment Reference', 'Date & Time'],
      ...sorted.map((o, i) => {
        const ts = o.timestamp?.toDate ? o.timestamp.toDate() : null;
        return [
          i + 1,
          o.name        || '',
          o.committee   || '',
          o.email       || '',
          o.phone       || '',
          o.paymentRef  || '',
          ts ? ts.toISOString() : ''
        ];
      })
    ];
    const csv  = rows.map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href     = url;
    a.download = 'midnight-in-love-orders.csv';
    a.click();
    URL.revokeObjectURL(url);
  });

  /* ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ */
  function esc(str) {
    return String(str)
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;').replace(/'/g,'&#039;');
  }
</script>
</body>
</html>
