<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Francis Personal Portal - Manage finances, budgets, tasks, and more with AI assistance">
    <meta name="theme-color" content="#4f46e5">
    <title>Francis Personal Portal</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://www.gstatic.com">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f0f4ff;
        }

        /* Login Screen */
        .login-container {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #a855f7 100%);
            position: relative;
            overflow: hidden;
        }

        .login-container::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.12) 0%, transparent 50%),
                        radial-gradient(circle at 70% 80%, rgba(255,255,255,0.08) 0%, transparent 50%);
        }

        .login-card {
            background: rgba(255, 255, 255, 0.97);
            padding: 48px;
            border-radius: 24px;
            box-shadow: 0 24px 80px rgba(79, 70, 229, 0.35), 0 0 0 1px rgba(255,255,255,0.2);
            max-width: 420px;
            width: 90%;
            position: relative;
        }

        .login-icon {
            text-align: center;
            font-size: 64px;
            margin-bottom: 20px;
            filter: drop-shadow(0 4px 8px rgba(79,70,229,0.3));
        }

        .login-title {
            text-align: center;
            font-size: 30px;
            font-weight: 800;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        .login-subtitle {
            text-align: center;
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 32px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 13px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.2s;
            background: #fafafa;
        }

        .form-input:focus {
            outline: none;
            border-color: #4f46e5;
            background: white;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        }

        .btn-primary {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 14px rgba(79, 70, 229, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.5);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .error-message {
            color: #dc2626;
            text-align: center;
            margin: 15px 0;
            font-size: 14px;
        }

        /* Dashboard */
        .dashboard {
            display: none;
            min-height: 100vh;
            background: #f0f4ff;
        }

        .dashboard.active {
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 16px 30px;
            box-shadow: 0 4px 20px rgba(79, 70, 229, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            font-size: 22px;
            font-weight: 700;
            letter-spacing: -0.3px;
        }

        .header-user {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.25);
            border: 2px solid rgba(255, 255, 255, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 17px;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 7px 18px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            font-size: 13px;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.28);
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex: 1;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: #0f172a;
            padding: 16px 0;
            flex-shrink: 0;
        }

        .nav-item {
            padding: 13px 22px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #94a3b8;
            font-weight: 500;
            font-size: 14px;
            border-left: 3px solid transparent;
            margin: 2px 0;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.06);
            color: #e2e8f0;
            border-left-color: rgba(99, 102, 241, 0.5);
        }

        .nav-item.active {
            background: rgba(99, 102, 241, 0.18);
            border-left: 3px solid #818cf8;
            color: #c7d2fe;
            font-weight: 600;
        }

        .nav-icon {
            font-size: 20px;
            width: 28px;
            text-align: center;
            flex-shrink: 0;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
            min-height: calc(100vh - 58px);
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .page-header {
            margin-bottom: 28px;
        }

        .page-title {
            font-size: 30px;
            font-weight: 800;
            color: #0f172a;
            margin-bottom: 6px;
            letter-spacing: -0.5px;
        }

        .page-subtitle {
            font-size: 15px;
            color: #64748b;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.06);
            margin-bottom: 20px;
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: #0f172a;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 28px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.06);
            border: 1px solid rgba(226, 232, 240, 0.8);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .stat-card.income::before { background: linear-gradient(90deg, #10b981, #34d399); }
        .stat-card.expenses::before { background: linear-gradient(90deg, #ef4444, #f87171); }
        .stat-card.budget::before { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
        .stat-card.savings::before { background: linear-gradient(90deg, #8b5cf6, #a78bfa); }
        .stat-card:not(.income):not(.expenses):not(.budget):not(.savings)::before {
            background: linear-gradient(90deg, #6366f1, #818cf8);
        }

        .stat-label {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 30px;
            font-weight: 800;
            color: #0f172a;
            letter-spacing: -0.5px;
        }

        .stat-change {
            font-size: 13px;
            margin-top: 8px;
            color: #64748b;
        }

        .stat-change.positive {
            color: #10b981;
        }

        .stat-change.negative {
            color: #ef4444;
        }

        /* Buttons */
        .btn {
            padding: 9px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #059669, #047857);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        /* Forms */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-control {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            background: #fafafa;
            transition: all 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: #4f46e5;
            background: white;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        select.form-control {
            cursor: pointer;
        }

        /* Transaction List */
        .transaction-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-description {
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 3px;
        }

        .transaction-meta {
            font-size: 13px;
            color: #64748b;
        }

        .transaction-amount {
            font-size: 17px;
            font-weight: 700;
        }

        .transaction-amount.expense {
            color: #ef4444;
        }

        .transaction-amount.income {
            color: #10b981;
        }

        /* Blog Editor */
        .editor-toolbar {
            display: flex;
            gap: 5px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 10px 10px 0 0;
            border: 2px solid #e5e7eb;
            border-bottom: none;
            flex-wrap: wrap;
        }

        .editor-btn {
            padding: 7px 12px;
            border: none;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            color: #374151;
        }

        .editor-btn:hover {
            background: #e5e7eb;
        }

        .editor-content {
            min-height: 300px;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 0 0 10px 10px;
            background: white;
            outline: none;
            font-size: 14px;
            line-height: 1.7;
        }

        .blog-post {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.06);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        .blog-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #0f172a;
        }

        .blog-meta {
            font-size: 13px;
            color: #64748b;
            margin-bottom: 14px;
        }

        .blog-content {
            line-height: 1.8;
            color: #374151;
        }

        .blog-actions {
            margin-top: 16px;
            display: flex;
            gap: 10px;
        }

        /* File Upload */
        .file-upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #f8fafc;
        }

        .file-upload-area:hover {
            border-color: #4f46e5;
            background: #eef2ff;
        }

        .file-upload-area.dragover {
            border-color: #4f46e5;
            background: #e0e7ff;
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            background: #f8fafc;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid #e5e7eb;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .file-icon {
            font-size: 30px;
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 3px;
        }

        .file-size {
            font-size: 13px;
            color: #64748b;
        }

        /* Chat Interface */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 300px);
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.06);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .chat-bubble {
            display: flex;
            margin-bottom: 18px;
        }

        .chat-bubble.user {
            flex-direction: row-reverse;
        }

        .chat-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 17px;
        }

        .chat-avatar.ai {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            margin-right: 12px;
        }

        .chat-avatar.user {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            margin-left: 12px;
        }

        .chat-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 16px;
        }

        .chat-bubble.ai .chat-content {
            background: #f1f5f9;
            color: #0f172a;
            border-radius: 4px 16px 16px 16px;
        }

        .chat-bubble.user .chat-content {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            border-radius: 16px 4px 16px 16px;
        }

        .chat-input-container {
            padding: 18px 20px;
            background: #f8fafc;
            border-top: 1px solid #e5e7eb;
        }

        .chat-input-row {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            resize: none;
            background: white;
            transition: all 0.2s;
        }

        .chat-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .btn-send {
            padding: 12px 22px;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3);
        }

        .btn-send:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
        }

        /* AI Message Formatting */
        .ai-message-content {
            line-height: 1.7;
        }
        
        .ai-message-content strong {
            font-weight: 700;
            color: #0f172a;
        }
        
        .ai-message-content em {
            font-style: italic;
            color: #374151;
        }
        
        .ai-message-content a {
            color: #4f46e5;
            text-decoration: underline;
            word-break: break-all;
        }
        
        .ai-message-content a:hover {
            color: #4338ca;
        }
        
        .ai-message-content code {
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        /* Task List */
        .task-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            background: #f8fafc;
            border-radius: 10px;
            margin-bottom: 8px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
        }

        .task-item:hover {
            border-color: #c7d2fe;
            background: #eef2ff;
        }

        .task-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #4f46e5;
        }

        .task-text {
            flex: 1;
            font-size: 14px;
            color: #0f172a;
        }

        .task-text.completed {
            text-decoration: line-through;
            color: #94a3b8;
        }

        .task-priority {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }

        .task-priority.high {
            background: #fee2e2;
            color: #dc2626;
        }

        .task-priority.medium {
            background: #fef3c7;
            color: #d97706;
        }

        .task-priority.low {
            background: #dbeafe;
            color: #2563eb;
        }

        /* Utilities */
        .hidden {
            display: none !important;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }

        .empty-icon {
            font-size: 60px;
            margin-bottom: 14px;
            opacity: 0.4;
        }

        /* Sidebar toggle button (mobile only) */
        .sidebar-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 4px 8px;
            line-height: 1;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar-toggle {
                display: block;
            }

            .header {
                padding: 12px 16px;
            }

            .header-title {
                font-size: 18px;
            }

            .logout-btn {
                padding: 6px 12px;
                font-size: 13px;
            }

            .user-avatar {
                width: 32px;
                height: 32px;
                font-size: 15px;
            }

            /* Sidebar becomes collapsible overlay */
            .sidebar {
                position: fixed;
                top: 0;
                left: -260px;
                width: 220px;
                height: 100%;
                z-index: 1000;
                padding-top: 60px;
                transition: left 0.3s ease;
                box-shadow: 4px 0 24px rgba(0,0,0,0.3);
            }

            .sidebar.open {
                left: 0;
            }

            .sidebar-backdrop {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.5);
                z-index: 999;
            }

            .sidebar-backdrop.active {
                display: block;
            }

            .nav-item {
                padding: 14px 18px;
                font-size: 14px;
            }

            .content-area {
                padding: 14px;
            }

            .page-title {
                font-size: 22px;
            }

            .page-subtitle {
                font-size: 14px;
            }

            .page-header {
                margin-bottom: 16px;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 12px;
                margin-bottom: 16px;
            }

            .stat-card {
                padding: 16px;
            }

            .stat-value {
                font-size: 22px;
            }

            .card {
                padding: 16px;
                margin-bottom: 14px;
            }

            .card-title {
                font-size: 16px;
            }

            .chat-content {
                max-width: 88%;
            }

            .chat-container {
                height: calc(100vh - 260px);
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .header-title {
                font-size: 15px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .stat-value {
                font-size: 20px;
            }

            .page-title {
                font-size: 18px;
            }

            .content-area {
                padding: 10px;
            }

            .card {
                padding: 12px;
            }

            .btn {
                padding: 8px 14px;
                font-size: 13px;
            }

            .transaction-amount {
                font-size: 15px;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-container">
        <div class="loading">Loading...</div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-container hidden">
        <div class="login-card">
            <div class="login-icon">üîê</div>
            <div class="login-title">Francis Portal</div>
            <div class="login-subtitle">Your Personal Command Center</div>

            <form id="loginForm">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" class="form-input" placeholder="pwavwef@gmail.com" required>
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" class="form-input" placeholder="Password" required>
                </div>

                <div id="errorMessage" class="error-message hidden"></div>

                <button type="submit" id="loginBtn" class="btn-primary">Sign In</button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <div class="header">
            <div style="display:flex;align-items:center;gap:12px;">
                <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar" aria-expanded="false">‚ò∞</button>
                <div class="header-title">Francis Portal</div>
            </div>
            <div class="header-user">
                <div class="user-avatar">üë§</div>
                <button id="logoutBtn" class="logout-btn">Sign Out</button>
            </div>
        </div>

        <div class="main-content">
            <div id="sidebarBackdrop" class="sidebar-backdrop" aria-hidden="true"></div>
            <div class="sidebar" id="sidebar">
                <div class="nav-item active" data-screen="dashboard">
                    <div class="nav-icon">üìä</div>
                    <div class="nav-label">Dashboard</div>
                </div>
                <div class="nav-item" data-screen="finances">
                    <div class="nav-icon">üí∞</div>
                    <div class="nav-label">Finances</div>
                </div>
                <div class="nav-item" data-screen="budget">
                    <div class="nav-icon">üíµ</div>
                    <div class="nav-label">Budget</div>
                </div>
                <div class="nav-item" data-screen="planning">
                    <div class="nav-icon">üìù</div>
                    <div class="nav-label">Planning</div>
                </div>
                <div class="nav-item" data-screen="blogs">
                    <div class="nav-icon">‚úçÔ∏è</div>
                    <div class="nav-label">Blogs</div>
                </div>
                <div class="nav-item" data-screen="projects">
                    <div class="nav-icon">üìÅ</div>
                    <div class="nav-label">Projects</div>
                </div>
                <div class="nav-item" data-screen="messages">
                    <div class="nav-icon">üìß</div>
                    <div class="nav-label">Messages</div>
                </div>
                <div class="nav-item" data-screen="ai">
                    <div class="nav-icon">ü§ñ</div>
                    <div class="nav-label">AI Assistant</div>
                </div>
                <div class="nav-item" data-screen="mealplanner">
                    <div class="nav-icon">üçΩÔ∏è</div>
                    <div class="nav-label">Meal Planner</div>
                </div>
            </div>

            <div class="content-area">
                <!-- Dashboard Screen -->
                <div id="dashboardScreen" class="screen active">
                    <div class="page-header">
                        <h1 class="page-title">Dashboard</h1>
                        <p class="page-subtitle">Overview of your portal</p>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card expenses">
                            <div class="stat-label">Total Expenses</div>
                            <div class="stat-value" id="dashTotalExpenses">GH‚Çµ 0</div>
                            <div class="stat-change">This month</div>
                        </div>
                        <div class="stat-card budget">
                            <div class="stat-label">Monthly Budget</div>
                            <div class="stat-value" id="dashMonthlyBudget">GH‚Çµ 0</div>
                            <div class="stat-change">Remaining</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Active Tasks</div>
                            <div class="stat-value" id="dashActiveTasks">0</div>
                            <div class="stat-change">In planning</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Blog Posts</div>
                            <div class="stat-value" id="dashBlogCount">0</div>
                            <div class="stat-change">Published</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Quick Actions</h3>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-success" onclick="switchScreen('finances')">Add Expense</button>
                            <button class="btn btn-info" onclick="switchScreen('planning')">Add Task</button>
                            <button class="btn btn-success" onclick="switchScreen('blogs')">Write Blog</button>
                            <button class="btn btn-info" onclick="switchScreen('projects')">Upload File</button>
                        </div>
                    </div>
                </div>

                <!-- Finances Screen -->
                <div id="financesScreen" class="screen">
                    <div class="page-header">
                        <h1 class="page-title">üí∞ Finances</h1>
                        <p class="page-subtitle">Track your spending, manage your budget</p>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card income">
                            <div class="stat-label">Total Income</div>
                            <div class="stat-value" id="totalIncome">GH‚Çµ 0</div>
                        </div>
                        <div class="stat-card expenses">
                            <div class="stat-label">Total Expenses</div>
                            <div class="stat-value" id="totalExpenses">GH‚Çµ 0</div>
                        </div>
                        <div class="stat-card budget">
                            <div class="stat-label">Budget Remaining</div>
                            <div class="stat-value" id="budgetRemaining">GH‚Çµ 0</div>
                        </div>
                        <div class="stat-card savings">
                            <div class="stat-label">Net Balance</div>
                            <div class="stat-value" id="netBalance">GH‚Çµ 0</div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Add Transaction</h3>
                            </div>
                            <form id="transactionForm">
                                <div class="form-group">
                                    <label>Type</label>
                                    <select id="txType" class="form-control" required>
                                        <option value="expense">Expense</option>
                                        <option value="income">Income</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Category</label>
                                    <select id="txCategory" class="form-control" required>
                                        <option value="Food">Food</option>
                                        <option value="Airtime">Airtime</option>
                                        <option value="Transport">Transport</option>
                                        <option value="Education">Education</option>
                                        <option value="Entertainment">Entertainment</option>
                                        <option value="Health">Health</option>
                                        <option value="Utilities">Utilities</option>
                                        <option value="Personal Care">Personal Care</option>
                                        <option value="Saving">Saving</option>
                                        <option value="Clothing">Clothing</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Amount (GH‚Çµ)</label>
                                    <input type="number" id="txAmount" class="form-control" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label>Description</label>
                                    <input type="text" id="txDescription" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label>Date</label>
                                    <input type="date" id="txDate" class="form-control" required>
                                </div>
                                <button type="submit" class="btn btn-success" style="width: 100%;">Add
                                    Transaction</button>
                            </form>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Spending by Category</h3>
                            </div>
                            <canvas id="spendingChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Recent Transactions</h3>
                        </div>
                        <div id="transactionList" class="transaction-list"></div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üìã Expected Expenses</h3>
                            <button class="btn btn-info" onclick="getExpensesPlanningAdvice()">üí° AI Plan</button>
                        </div>
                        <p style="font-size: 14px; color: #718096; margin-bottom: 15px;">Add upcoming expenses you expect to have ‚Äî the AI will help you plan before you spend.</p>
                        <form id="expectedExpenseForm">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; margin-bottom: 10px;">
                                <select id="expCategory" class="form-control" required>
                                    <option value="Food">Food</option>
                                    <option value="Airtime">Airtime</option>
                                    <option value="Transport">Transport</option>
                                    <option value="Education">Education</option>
                                    <option value="Entertainment">Entertainment</option>
                                    <option value="Health">Health</option>
                                    <option value="Utilities">Utilities</option>
                                    <option value="Personal Care">Personal Care</option>
                                    <option value="Saving">Saving</option>
                                    <option value="Clothing">Clothing</option>
                                    <option value="Other">Other</option>
                                </select>
                                <input type="number" id="expAmount" class="form-control" placeholder="Amount (GH‚Çµ)" step="0.01" required>
                                <input type="text" id="expDescription" class="form-control" placeholder="Description" required>
                                <input type="date" id="expDate" class="form-control" required>
                                <button type="submit" class="btn btn-success">Add</button>
                            </div>
                        </form>
                        <div id="expectedExpenseList" class="transaction-list" style="max-height: 300px;"></div>
                        <div id="expensesPlanningAdvice" style="margin-top: 15px; line-height: 1.8; color: #4a5568;"></div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üí° AI Financial Advice</h3>
                            <button class="btn btn-info" onclick="getFinancialAdvice()">Get Advice</button>
                        </div>
                        <div id="financialAdvice" style="line-height: 1.8; color: #4a5568;"></div>
                    </div>
                </div>

                <!-- Budget Screen -->
                <div id="budgetScreen" class="screen">
                    <div class="page-header">
                        <h1 class="page-title">üíµ Budget Tools</h1>
                        <p class="page-subtitle">Financial calculators and planning tools</p>
                    </div>

                    <!-- Financial Calculators Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        
                        <!-- Savings Calculator -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">üí∞ Savings Calculator</h3>
                            </div>
                            <div class="form-group">
                                <label>Initial Amount (GH‚Çµ)</label>
                                <input type="number" id="savingsInitial" class="form-control" value="1000" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Monthly Contribution (GH‚Çµ)</label>
                                <input type="number" id="savingsMonthly" class="form-control" value="100" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Interest Rate (% per year)</label>
                                <input type="number" id="savingsRate" class="form-control" value="5" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Years</label>
                                <input type="number" id="savingsYears" class="form-control" value="5" step="1">
                            </div>
                            <button class="btn btn-info" onclick="calculateSavings()" style="width: 100%;">Calculate</button>
                            <div id="savingsResult" class="result-box" style="margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 8px; display: none;">
                                <h4 style="margin-bottom: 10px; color: #0369a1;">Results:</h4>
                                <div id="savingsResultText"></div>
                            </div>
                        </div>

                        <!-- Loan Calculator -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">üè¶ Loan Calculator</h3>
                            </div>
                            <div class="form-group">
                                <label>Loan Amount (GH‚Çµ)</label>
                                <input type="number" id="loanAmount" class="form-control" value="10000" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Interest Rate (% per year)</label>
                                <input type="number" id="loanRate" class="form-control" value="15" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Loan Term (months)</label>
                                <input type="number" id="loanMonths" class="form-control" value="12" step="1">
                            </div>
                            <button class="btn btn-info" onclick="calculateLoan()" style="width: 100%;">Calculate</button>
                            <div id="loanResult" class="result-box" style="margin-top: 15px; padding: 15px; background: #fef3c7; border-radius: 8px; display: none;">
                                <h4 style="margin-bottom: 10px; color: #92400e;">Results:</h4>
                                <div id="loanResultText"></div>
                            </div>
                        </div>

                        <!-- Investment Return Calculator -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">üìà Investment Calculator</h3>
                            </div>
                            <div class="form-group">
                                <label>Initial Investment (GH‚Çµ)</label>
                                <input type="number" id="investAmount" class="form-control" value="5000" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Expected Return (% per year)</label>
                                <input type="number" id="investReturn" class="form-control" value="12" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Investment Period (years)</label>
                                <input type="number" id="investYears" class="form-control" value="10" step="1">
                            </div>
                            <div class="form-group">
                                <label>Additional Annual Contribution (GH‚Çµ)</label>
                                <input type="number" id="investAnnual" class="form-control" value="1000" step="0.01">
                            </div>
                            <button class="btn btn-info" onclick="calculateInvestment()" style="width: 100%;">Calculate</button>
                            <div id="investResult" class="result-box" style="margin-top: 15px; padding: 15px; background: #f0fdf4; border-radius: 8px; display: none;">
                                <h4 style="margin-bottom: 10px; color: #065f46;">Results:</h4>
                                <div id="investResultText"></div>
                            </div>
                        </div>

                        <!-- Budget Breakdown Tool -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">üìä 50/30/20 Budget Rule</h3>
                            </div>
                            <div class="form-group">
                                <label>Monthly Income (GH‚Çµ)</label>
                                <input type="number" id="budgetIncome" class="form-control" value="3000" step="0.01">
                            </div>
                            <button class="btn btn-info" onclick="calculateBudgetRule()" style="width: 100%;">Calculate</button>
                            <div id="budgetRuleResult" class="result-box" style="margin-top: 15px; padding: 15px; background: #faf5ff; border-radius: 8px; display: none;">
                                <h4 style="margin-bottom: 10px; color: #6b21a8;">Recommended Budget:</h4>
                                <div id="budgetRuleText"></div>
                            </div>
                        </div>

                        <!-- Emergency Fund Calculator -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">üõ°Ô∏è Emergency Fund</h3>
                            </div>
                            <div class="form-group">
                                <label>Monthly Expenses (GH‚Çµ)</label>
                                <input type="number" id="emergencyExpenses" class="form-control" value="2000" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Months to Cover</label>
                                <input type="number" id="emergencyMonths" class="form-control" value="6" step="1">
                            </div>
                            <div class="form-group">
                                <label>Current Savings (GH‚Çµ)</label>
                                <input type="number" id="emergencySavings" class="form-control" value="5000" step="0.01">
                            </div>
                            <button class="btn btn-info" onclick="calculateEmergencyFund()" style="width: 100%;">Calculate</button>
                            <div id="emergencyResult" class="result-box" style="margin-top: 15px; padding: 15px; background: #fef2f2; border-radius: 8px; display: none;">
                                <h4 style="margin-bottom: 10px; color: #991b1b;">Results:</h4>
                                <div id="emergencyResultText"></div>
                            </div>
                        </div>

                        <!-- Tax Calculator (Ghana) -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">üßæ Income Tax Calculator (Ghana)</h3>
                            </div>
                            <div class="form-group">
                                <label>Annual Income (GH‚Çµ)</label>
                                <input type="number" id="taxIncome" class="form-control" value="50000" step="0.01">
                            </div>
                            <button class="btn btn-info" onclick="calculateTax()" style="width: 100%;">Calculate Tax</button>
                            <div id="taxResult" class="result-box" style="margin-top: 15px; padding: 15px; background: #ecfeff; border-radius: 8px; display: none;">
                                <h4 style="margin-bottom: 10px; color: #155e75;">Results:</h4>
                                <div id="taxResultText"></div>
                            </div>
                        </div>

                    </div>

                    <!-- Budget Tips Card -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üí° Smart Budgeting Tips</h3>
                        </div>
                        <div style="line-height: 1.8; color: #4a5568; padding: 10px;">
                            <ul style="padding-left: 20px;">
                                <li><strong>Track every expense:</strong> Use the Finances tab to monitor your spending patterns</li>
                                <li><strong>Follow the 50/30/20 rule:</strong> 50% needs, 30% wants, 20% savings</li>
                                <li><strong>Build an emergency fund:</strong> Aim for 3-6 months of expenses</li>
                                <li><strong>Automate savings:</strong> Set up automatic transfers to your savings account</li>
                                <li><strong>Review monthly:</strong> Check your budget progress regularly and adjust as needed</li>
                                <li><strong>Avoid impulse purchases:</strong> Wait 24 hours before making non-essential purchases</li>
                                <li><strong>Use cash envelopes:</strong> Allocate cash for specific spending categories</li>
                                <li><strong>Plan for irregular expenses:</strong> Set aside money for annual bills and emergencies</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Planning Screen -->
                <div id="planningScreen" class="screen">
                    <div class="page-header">
                        <h1 class="page-title">üìù Planning</h1>
                        <p class="page-subtitle">Organize your tasks and goals</p>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Add New Task</h3>
                        </div>
                        <form id="taskForm">
                            <div class="form-row">
                                <input type="text" id="taskTitle" class="form-control" placeholder="Task title"
                                    required>
                                <select id="taskPriority" class="form-control">
                                    <option value="low">Low Priority</option>
                                    <option value="medium">Medium Priority</option>
                                    <option value="high">High Priority</option>
                                </select>
                                <input type="date" id="taskDueDate" class="form-control" required>
                                <button type="submit" class="btn btn-success">Add Task</button>
                            </div>
                        </form>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Tasks</h3>
                        </div>
                        <div id="taskList"></div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ü§ñ AI Planning Advice</h3>
                            <button class="btn btn-info" onclick="getPlanningAdvice()">Get Advice</button>
                        </div>
                        <div id="planningAdvice" style="line-height: 1.8; color: #4a5568;"></div>
                    </div>
                </div>

                <!-- Blogs Screen -->
                <div id="blogsScreen" class="screen">
                    <div class="page-header">
                        <h1 class="page-title">‚úçÔ∏è Blogs</h1>
                        <p class="page-subtitle">Share your thoughts and ideas</p>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Write New Blog Post</h3>
                        </div>
                        <form id="blogForm">
                            <div class="form-group">
                                <input type="text" id="blogTitle" class="form-control" placeholder="Blog Title"
                                    required>
                            </div>
                            <div class="editor-toolbar">
                                <button type="button" class="editor-btn" onclick="formatText('bold')"><b>B</b></button>
                                <button type="button" class="editor-btn"
                                    onclick="formatText('italic')"><i>I</i></button>
                                <button type="button" class="editor-btn"
                                    onclick="formatText('underline')"><u>U</u></button>
                                <button type="button" class="editor-btn" onclick="formatText('insertOrderedList')">1.
                                    List</button>
                                <button type="button" class="editor-btn" onclick="formatText('insertUnorderedList')">‚Ä¢
                                    List</button>
                                <button type="button" class="editor-btn" onclick="insertLink()">üîó Link</button>
                                <button type="button" class="editor-btn" onclick="insertImage()">üñºÔ∏è Image</button>
                                <select class="editor-btn" onchange="formatHeading(this.value)">
                                    <option value="">Heading</option>
                                    <option value="h1">Heading 1</option>
                                    <option value="h2">Heading 2</option>
                                    <option value="h3">Heading 3</option>
                                </select>
                            </div>
                            <div id="blogEditor" class="editor-content" contenteditable="true"></div>
                            <div class="form-group" style="margin-top: 15px;">
                                <button type="submit" class="btn btn-success">Publish Blog Post</button>
                            </div>
                        </form>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Published Blogs</h3>
                        </div>
                        <div id="blogList"></div>
                    </div>
                </div>

                <!-- Projects Screen -->
                <div id="projectsScreen" class="screen">
                    <div class="page-header">
                        <h1 class="page-title">üìÅ Projects</h1>
                        <p class="page-subtitle">Upload and manage your project files</p>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Upload Files</h3>
                        </div>
                        <div class="file-upload-area" id="fileUploadArea">
                            <div style="font-size: 48px; margin-bottom: 15px;">üì§</div>
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Drop files here or click
                                to upload</div>
                            <div style="font-size: 14px; color: #718096;">Supported files: PDF, DOC, DOCX, XLS, XLSX,
                                PPT, PPTX, ZIP, Images</div>
                            <input type="file" id="fileInput" multiple style="display: none;">
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">My Files</h3>
                        </div>
                        <div id="fileList" class="file-list"></div>
                    </div>
                </div>

                <!-- Messages Screen -->
                <div id="messagesScreen" class="screen">
                    <div class="page-header">
                        <h1 class="page-title">üìß Messages</h1>
                        <p class="page-subtitle">Messages from your website contact form</p>
                    </div>
                    <div id="messagesContent"></div>
                </div>

                <!-- AI Assistant Screen -->
                <div id="aiScreen" class="screen">
                    <div class="page-header">
                        <h1 class="page-title">ü§ñ AI Assistant</h1>
                        <p class="page-subtitle">Your personal AI advisor</p>
                    </div>

                    <div class="chat-container">
                        <div id="chatMessages" class="chat-messages"></div>
                        <div class="chat-input-container">
                            <div class="chat-input-row">
                                <textarea id="chatInput" class="chat-input" placeholder="Ask anything..."
                                    rows="1"></textarea>
                                <button id="sendBtn" class="btn-send">Send</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Meal Planner Screen -->
                <div id="mealplannerScreen" class="screen">
                    <div class="page-header">
                        <h1 class="page-title">üçΩÔ∏è Meal Planner</h1>
                        <p class="page-subtitle">AI-powered daily meal planning within your budget</p>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Today's Meal Plan</h3>
                            <button class="btn btn-info" onclick="regenerateTodayMealPlan()">üîÑ Regenerate</button>
                        </div>
                        <div id="todayMealPlan">
                            <div class="loading">Opening meal planner‚Ä¶</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üìÖ Previous Meal Plans</h3>
                        </div>
                        <p style="font-size: 14px; color: #718096; margin-bottom: 15px;">Past plans are saved to help the AI provide variety and better nutrition over time.</p>
                        <div id="mealPlanHistory"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js';
        import { getFirestore, collection, query, orderBy, onSnapshot, addDoc, deleteDoc, doc, serverTimestamp, where, getDocs, updateDoc } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject, listAll } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js';
        import { getVertexAI, getGenerativeModel } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-vertexai.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: 'AIzaSyB6lxgjNY4CRNHAe3pAgR5SYv1ohL8brOI',
            authDomain: 'francis-pwavwe.firebaseapp.com',
            projectId: 'francis-pwavwe',
            storageBucket: 'francis-pwavwe.firebasestorage.app',
            messagingSenderId: '658069378543',
            appId: '1:658069378543:web:87b1dcb0dd27d3255bd21a'
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Initialize Vertex AI
        const vertexAI = getVertexAI(app);
        
        // --- FIX IS HERE: Updated from "gemini-1.5-flash" to "gemini-2.0-flash" ---
        const model = getGenerativeModel(vertexAI, { model: "gemini-2.0-flash" });

        // Global state
        let currentUser = null;
        let transactions = [];
        let tasks = [];
        let blogs = [];
        let spendingChart = null;
        let expectedExpenses = [];
        let mealPlans = [];
        let autoMealPlanGenerated = false;
        let mealPlansLoaded = false;
        let pendingMealPlannerOpen = false;
        
        // Configurable settings
        const MONTHLY_BUDGET = 600; 

        // DOM elements
        const loadingScreen = document.getElementById('loadingScreen');
        const loginScreen = document.getElementById('loginScreen');
        const dashboard = document.getElementById('dashboard');
        const loginForm = document.getElementById('loginForm');
        const errorMessage = document.getElementById('errorMessage');
        const logoutBtn = document.getElementById('logoutBtn');

        // Auth state observer
        onAuthStateChanged(auth, (user) => {
            loadingScreen.classList.add('hidden');
            
            if (user && user.email === 'pwavwef@gmail.com') {
                currentUser = user;
                loginScreen.classList.add('hidden');
                dashboard.classList.add('active');
                initializePortal();
            } else {
                if (user) {
                    signOut(auth);
                }
                loginScreen.classList.remove('hidden');
                dashboard.classList.remove('active');
            }
        });

        // Login form handler
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            if (email !== 'pwavwef@gmail.com') {
                showError('Access denied. This portal is for Francis only.');
                return;
            }
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showError(error.message || 'Authentication failed');
            }
        });

        // Logout handler
        logoutBtn.addEventListener('click', async () => {
            await signOut(auth);
        });

        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const screenId = item.dataset.screen;
                switchScreen(screenId);
                // Close sidebar on mobile after selecting a screen
                closeSidebar();
            });
        });

        // Sidebar toggle for mobile
        const sidebarEl = document.getElementById('sidebar');
        const sidebarBackdrop = document.getElementById('sidebarBackdrop');
        const sidebarToggleBtn = document.getElementById('sidebarToggle');

        function closeSidebar() {
            sidebarEl.classList.remove('open');
            sidebarBackdrop.classList.remove('active');
        }

        sidebarToggleBtn.addEventListener('click', () => {
            const isOpen = sidebarEl.classList.toggle('open');
            sidebarBackdrop.classList.toggle('active', isOpen);
            sidebarToggleBtn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        });

        sidebarBackdrop.addEventListener('click', () => {
            closeSidebar();
            sidebarToggleBtn.setAttribute('aria-expanded', 'false');
        });

        window.switchScreen = function(screenId) {
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            document.querySelector(`[data-screen="${screenId}"]`).classList.add('active');
            
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById(`${screenId}Screen`).classList.add('active');

            if (screenId === 'mealplanner') {
                onMealPlannerOpen();
            }
        };

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        // Initialize portal modules
        function initializePortal() {
            initializeFinances();
            initializePlanning();
            initializeBlogs();
            initializeProjects();
            initializeMessages();
            initializeAI();
            initializeExpectedExpenses();
            initializeMealPlanner();
            updateDashboard();
        }

        // ===== FINANCES =====
        function initializeFinances() {
            document.getElementById('txDate').valueAsDate = new Date();

            document.getElementById('transactionForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const type = document.getElementById('txType').value;
                const category = document.getElementById('txCategory').value;
                const amount = parseFloat(document.getElementById('txAmount').value);
                const description = document.getElementById('txDescription').value;
                const date = document.getElementById('txDate').value;

                try {
                    await addDoc(collection(db, 'transactions'), {
                        type,
                        category,
                        amount,
                        description,
                        date,
                        timestamp: serverTimestamp(),
                        userId: currentUser.uid
                    });

                    e.target.reset();
                    document.getElementById('txDate').valueAsDate = new Date();
                    alert('Transaction added successfully!');
                } catch (error) {
                    alert('Error adding transaction: ' + error.message);
                }
            });

            const q = query(
                collection(db, 'transactions'),
                where('userId', '==', currentUser.uid),
                orderBy('timestamp', 'desc')
            );

            onSnapshot(q, (snapshot) => {
                transactions = [];
                snapshot.forEach((doc) => {
                    transactions.push({ id: doc.id, ...doc.data() });
                });
                updateFinances();
                updateDashboard(); 
            });
        }

        function updateFinances() {
            let totalIncome = 0;
            let totalExpenses = 0;
            const categoryExpenses = {};

            transactions.forEach(tx => {
                if (tx.type === 'income') {
                    totalIncome += tx.amount;
                } else {
                    totalExpenses += tx.amount;
                    categoryExpenses[tx.category] = (categoryExpenses[tx.category] || 0) + tx.amount;
                }
            });

            const netBalance = totalIncome - totalExpenses;
            const budgetRemaining = MONTHLY_BUDGET - totalExpenses;

            document.getElementById('totalIncome').textContent = `GH‚Çµ ${totalIncome.toFixed(2)}`;
            document.getElementById('totalExpenses').textContent = `GH‚Çµ ${totalExpenses.toFixed(2)}`;
            document.getElementById('budgetRemaining').textContent = `GH‚Çµ ${budgetRemaining.toFixed(2)}`;
            document.getElementById('netBalance').textContent = `GH‚Çµ ${netBalance.toFixed(2)}`;

            const txList = document.getElementById('transactionList');
            if (transactions.length === 0) {
                txList.innerHTML = '<div class="empty-state"><div class="empty-icon">üí∏</div><div>No transactions yet</div></div>';
            } else {
                txList.innerHTML = transactions.slice(0, 10).map(tx => `
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <div class="transaction-description">${escapeHtml(tx.description)}</div>
                            <div class="transaction-meta">${escapeHtml(tx.category)} ‚Ä¢ ${escapeHtml(tx.date)}</div>
                        </div>
                        <div class="transaction-amount ${tx.type}">
                            ${tx.type === 'income' ? '+' : '-'} GH‚Çµ ${tx.amount.toFixed(2)}
                        </div>
                    </div>
                `).join('');
            }

            updateSpendingChart(categoryExpenses);
        }

        function updateSpendingChart(categoryExpenses) {
            const canvas = document.getElementById('spendingChart');
            const ctx = canvas.getContext('2d');

            if (spendingChart) {
                spendingChart.destroy();
            }

            const categories = Object.keys(categoryExpenses);
            const amounts = Object.values(categoryExpenses);

            if (categories.length === 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '14px sans-serif';
                ctx.fillStyle = '#718096';
                ctx.textAlign = 'center';
                ctx.fillText('No spending data yet', canvas.width / 2, canvas.height / 2);
                return;
            }

            spendingChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: categories,
                    datasets: [{
                        data: amounts,
                        backgroundColor: [
                            '#ef4444', '#f59e0b', '#10b981', '#3b82f6',
                            '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16',
                            '#f97316', '#0ea5e9', '#a78bfa'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': GH‚Çµ ' + context.parsed.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        window.getFinancialAdvice = async function() {
            const adviceDiv = document.getElementById('financialAdvice');
            adviceDiv.innerHTML = '<div class="loading">Getting AI advice...</div>';

            const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            
            const categoryBreakdown = {};
            transactions.filter(t => t.type === 'expense').forEach(t => {
                categoryBreakdown[t.category] = (categoryBreakdown[t.category] || 0) + t.amount;
            });

            const prompt = `As a financial advisor, analyze this spending data and provide personalized advice:
- Total Income: GH‚Çµ ${totalIncome}
- Total Expenses: GH‚Çµ ${totalExpenses}
- Spending by category: ${JSON.stringify(categoryBreakdown)}

Provide specific advice on:
1. Budget optimization
2. Spending patterns
3. Savings recommendations
4. Areas to reduce spending`;

            try {
                const response = await callGeminiAPI(prompt);
                adviceDiv.innerHTML = response.replace(/\n/g, '<br>');
            } catch (error) {
                adviceDiv.innerHTML = `<div style="color: #ef4444;">Error getting advice: ${error.message}</div>`;
            }
        };

        // ===== EXPECTED EXPENSES =====
        function initializeExpectedExpenses() {
            document.getElementById('expDate').valueAsDate = new Date();

            document.getElementById('expectedExpenseForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const category = document.getElementById('expCategory').value;
                const amount = parseFloat(document.getElementById('expAmount').value);
                const description = document.getElementById('expDescription').value;
                const date = document.getElementById('expDate').value;
                try {
                    await addDoc(collection(db, 'expectedExpenses'), {
                        category, amount, description, date,
                        timestamp: serverTimestamp(),
                        userId: currentUser.uid
                    });
                    e.target.reset();
                    document.getElementById('expDate').valueAsDate = new Date();
                } catch (error) {
                    alert('Error adding expected expense: ' + error.message);
                }
            });

            const q = query(
                collection(db, 'expectedExpenses'),
                where('userId', '==', currentUser.uid),
                orderBy('timestamp', 'desc')
            );

            onSnapshot(q, (snapshot) => {
                expectedExpenses = [];
                snapshot.forEach((docSnap) => {
                    expectedExpenses.push({ id: docSnap.id, ...docSnap.data() });
                });
                updateExpectedExpenseList();
            });
        }

        function updateExpectedExpenseList() {
            const list = document.getElementById('expectedExpenseList');
            if (expectedExpenses.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-icon">üìã</div><div>No expected expenses yet</div></div>';
                return;
            }
            list.innerHTML = expectedExpenses.slice(0, 15).map(exp => `
                <div class="transaction-item">
                    <div class="transaction-info">
                        <div class="transaction-description">${escapeHtml(exp.description)}</div>
                        <div class="transaction-meta">${escapeHtml(exp.category)} ‚Ä¢ ${escapeHtml(exp.date)}</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="transaction-amount expense">GH‚Çµ ${exp.amount.toFixed(2)}</div>
                        <button class="btn btn-danger" onclick="deleteExpectedExpense('${exp.id}')" style="padding: 6px 12px;">‚úï</button>
                    </div>
                </div>
            `).join('');
        }

        window.deleteExpectedExpense = async function(id) {
            if (confirm('Remove this expected expense?')) {
                try {
                    await deleteDoc(doc(db, 'expectedExpenses', id));
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }
        };

        window.getExpensesPlanningAdvice = async function() {
            const adviceDiv = document.getElementById('expensesPlanningAdvice');
            adviceDiv.innerHTML = '<div class="loading">ü§ñ Getting AI planning advice...</div>';

            const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const budgetRemaining = MONTHLY_BUDGET - totalExpenses;
            const totalExpected = expectedExpenses.reduce((sum, e) => sum + e.amount, 0);

            const prompt = `As a financial planning advisor for Francis, analyze these planned expenses and provide actionable advice:

Current Financial Status:
- Total Income: GH‚Çµ ${totalIncome}
- Total Expenses So Far: GH‚Çµ ${totalExpenses}
- Monthly Budget: GH‚Çµ ${MONTHLY_BUDGET}
- Budget Remaining: GH‚Çµ ${budgetRemaining}

Planned/Expected Expenses:
${expectedExpenses.map(e => `- ${e.description} (${e.category}): GH‚Çµ ${e.amount} on ${e.date}`).join('\n') || '(none added yet)'}
- Total Expected: GH‚Çµ ${totalExpected}

Please provide:
1. Whether these planned expenses are financially feasible
2. Prioritization ‚Äî which to tackle first and which can wait
3. Suggestions to cut costs or find alternatives
4. Impact on budget and savings goals`;

            try {
                const response = await callGeminiAPI(prompt);
                adviceDiv.innerHTML = `<div class="ai-message-content">${formatAIResponse(response)}</div>`;
            } catch (error) {
                adviceDiv.innerHTML = `<div style="color: #ef4444;">Error getting advice: ${error.message}</div>`;
            }
        };

        // ===== PLANNING =====
        function initializePlanning() {
            document.getElementById('taskForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const title = document.getElementById('taskTitle').value;
                const priority = document.getElementById('taskPriority').value;
                const dueDate = document.getElementById('taskDueDate').value;

                try {
                    await addDoc(collection(db, 'tasks'), {
                        title,
                        priority,
                        dueDate,
                        completed: false,
                        timestamp: serverTimestamp(),
                        userId: currentUser.uid
                    });

                    e.target.reset();
                    alert('Task added successfully!');
                } catch (error) {
                    alert('Error adding task: ' + error.message);
                }
            });

            const q = query(
                collection(db, 'tasks'),
                where('userId', '==', currentUser.uid),
                orderBy('timestamp', 'desc')
            );

            onSnapshot(q, (snapshot) => {
                tasks = [];
                snapshot.forEach((doc) => {
                    tasks.push({ id: doc.id, ...doc.data() });
                });
                updateTasks();
                updateDashboard();
            });
        }

        function updateTasks() {
            const taskList = document.getElementById('taskList');
            
            if (tasks.length === 0) {
                taskList.innerHTML = '<div class="empty-state"><div class="empty-icon">üìù</div><div>No tasks yet</div></div>';
                return;
            }

            taskList.innerHTML = tasks.map(task => `
                <div class="task-item">
                    <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''} 
                           onchange="toggleTask('${task.id}', this.checked)">
                    <div class="task-text ${task.completed ? 'completed' : ''}">${escapeHtml(task.title)}</div>
                    <div class="task-priority ${task.priority}">${task.priority}</div>
                    <div style="font-size: 13px; color: #718096;">${task.dueDate}</div>
                    <button class="btn btn-danger" onclick="deleteTask('${task.id}')" style="padding: 6px 12px;">Delete</button>
                </div>
            `).join('');
        }

        window.toggleTask = async function(taskId, completed) {
            try {
                await updateDoc(doc(db, 'tasks', taskId), { completed });
            } catch (error) {
                alert('Error updating task: ' + error.message);
            }
        };

        window.deleteTask = async function(taskId) {
            if (confirm('Delete this task?')) {
                try {
                    await deleteDoc(doc(db, 'tasks', taskId));
                } catch (error) {
                    alert('Error deleting task: ' + error.message);
                }
            }
        };

        window.getPlanningAdvice = async function() {
            const adviceDiv = document.getElementById('planningAdvice');
            adviceDiv.innerHTML = '<div class="loading">Getting AI advice...</div>';

            const activeTasks = tasks.filter(t => !t.completed);
            const tasksByPriority = {
                high: activeTasks.filter(t => t.priority === 'high').length,
                medium: activeTasks.filter(t => t.priority === 'medium').length,
                low: activeTasks.filter(t => t.priority === 'low').length
            };

            const prompt = `As a productivity advisor, analyze this task data and provide advice:
- Active tasks: ${activeTasks.length}
- High priority: ${tasksByPriority.high}
- Medium priority: ${tasksByPriority.medium}
- Low priority: ${tasksByPriority.low}
- Top tasks: ${activeTasks.slice(0, 5).map(t => t.title).join(', ')}

Provide specific advice on:
1. Task prioritization
2. Time management
3. Productivity tips
4. How to tackle tasks efficiently`;

            try {
                const response = await callGeminiAPI(prompt);
                adviceDiv.innerHTML = response.replace(/\n/g, '<br>');
            } catch (error) {
                adviceDiv.innerHTML = `<div style="color: #ef4444;">Error getting advice: ${error.message}</div>`;
            }
        };

        // ===== BLOGS =====
        function initializeBlogs() {
            document.getElementById('blogForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const title = document.getElementById('blogTitle').value;
                const content = document.getElementById('blogEditor').innerHTML;

                if (!content.trim()) {
                    alert('Please write some content');
                    return;
                }

                try {
                    await addDoc(collection(db, 'blogs'), {
                        title,
                        content,
                        timestamp: serverTimestamp(),
                        userId: currentUser.uid
                    });

                    document.getElementById('blogTitle').value = '';
                    document.getElementById('blogEditor').innerHTML = '';
                    alert('Blog published successfully!');
                } catch (error) {
                    alert('Error publishing blog: ' + error.message);
                }
            });

            const q = query(
                collection(db, 'blogs'),
                where('userId', '==', currentUser.uid),
                orderBy('timestamp', 'desc')
            );

            onSnapshot(q, (snapshot) => {
                blogs = [];
                snapshot.forEach((doc) => {
                    blogs.push({ id: doc.id, ...doc.data() });
                });
                updateBlogs();
                updateDashboard();
            });
        }

        function updateBlogs() {
            const blogList = document.getElementById('blogList');
            
            if (blogs.length === 0) {
                blogList.innerHTML = '<div class="empty-state"><div class="empty-icon">‚úçÔ∏è</div><div>No blog posts yet</div></div>';
                return;
            }

            blogList.innerHTML = blogs.map(blog => {
                const date = blog.timestamp?.toDate();
                const formattedDate = date ? new Intl.DateTimeFormat('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                }).format(date) : 'No date';

                return `
                    <div class="blog-post">
                        <h3 class="blog-title">${escapeHtml(blog.title)}</h3>
                        <div class="blog-meta">Published on ${formattedDate}</div>
                        <div class="blog-content">${blog.content}</div>
                        <div class="blog-actions">
                            <button class="btn btn-danger" onclick="deleteBlog('${blog.id}')">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.deleteBlog = async function(blogId) {
            if (confirm('Delete this blog post?')) {
                try {
                    await deleteDoc(doc(db, 'blogs', blogId));
                } catch (error) {
                    alert('Error deleting blog: ' + error.message);
                }
            }
        };

        window.formatText = function(command) {
            document.execCommand(command, false, null);
        };

        window.formatHeading = function(heading) {
            if (heading) {
                document.execCommand('formatBlock', false, heading);
            }
        };

        window.insertLink = function() {
            const url = prompt('Enter the URL:');
            if (url) {
                document.execCommand('createLink', false, url);
            }
        };

        window.insertImage = function() {
            const url = prompt('Enter the image URL:');
            if (url) {
                document.execCommand('insertImage', false, url);
            }
        };

        // ===== PROJECTS =====
        function initializeProjects() {
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileInput = document.getElementById('fileInput');

            fileUploadArea.addEventListener('click', () => fileInput.click());

            fileUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUploadArea.classList.add('dragover');
            });

            fileUploadArea.addEventListener('dragleave', () => {
                fileUploadArea.classList.remove('dragover');
            });

            fileUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });

            loadFiles();
        }

        async function handleFiles(files) {
            if (files.length === 0) return;

            for (let file of files) {
                try {
                    const storageRef = ref(storage, `projects/${currentUser.uid}/${file.name}`);
                    await uploadBytes(storageRef, file);
                    
                    const downloadURL = await getDownloadURL(storageRef);
                    
                    await addDoc(collection(db, 'projectFiles'), {
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        url: downloadURL,
                        path: storageRef.fullPath,
                        timestamp: serverTimestamp(),
                        userId: currentUser.uid
                    });
                } catch (error) {
                    alert('Error uploading ' + file.name + ': ' + error.message);
                }
            }

            fileInput.value = '';
            alert('Files uploaded successfully!');
        }

        async function loadFiles() {
            const q = query(
                collection(db, 'projectFiles'),
                where('userId', '==', currentUser.uid),
                orderBy('timestamp', 'desc')
            );

            onSnapshot(q, (snapshot) => {
                const files = [];
                snapshot.forEach((doc) => {
                    files.push({ id: doc.id, ...doc.data() });
                });
                displayFiles(files);
            });
        }

        function displayFiles(files) {
            const fileList = document.getElementById('fileList');
            
            if (files.length === 0) {
                fileList.innerHTML = '<div class="empty-state"><div class="empty-icon">üìÅ</div><div>No files uploaded yet</div></div>';
                return;
            }

            fileList.innerHTML = files.map(file => {
                const sizeKB = (file.size / 1024).toFixed(2);
                const icon = getFileIcon(file.type);

                return `
                    <div class="file-item">
                        <div class="file-info">
                            <div class="file-icon">${icon}</div>
                            <div class="file-details">
                                <div class="file-name">${escapeHtml(file.name)}</div>
                                <div class="file-size">${sizeKB} KB</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <a href="${file.url}" target="_blank" class="btn btn-info">Download</a>
                            <button class="btn btn-danger" onclick="deleteFile('${file.id}', '${file.path}')">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getFileIcon(type) {
            if (type.startsWith('image/')) return 'üñºÔ∏è';
            if (type.includes('pdf')) return 'üìÑ';
            if (type.includes('word') || type.includes('document')) return 'üìù';
            if (type.includes('sheet') || type.includes('excel')) return 'üìä';
            if (type.includes('presentation') || type.includes('powerpoint')) return 'üìΩÔ∏è';
            if (type.includes('zip') || type.includes('compressed')) return 'üóúÔ∏è';
            return 'üìé';
        }

        window.deleteFile = async function(fileId, filePath) {
            if (confirm('Delete this file?')) {
                try {
                    await deleteDoc(doc(db, 'projectFiles', fileId));
                    const storageRef = ref(storage, filePath);
                    await deleteObject(storageRef);
                } catch (error) {
                    alert('Error deleting file: ' + error.message);
                }
            }
        };

        // ===== MESSAGES =====
        function initializeMessages() {
            const q = query(collection(db, 'messages'), orderBy('timestamp', 'desc'));
            
            onSnapshot(q, (snapshot) => {
                const messagesContent = document.getElementById('messagesContent');
                
                if (snapshot.empty) {
                    messagesContent.innerHTML = '<div class="empty-state"><div class="empty-icon">üì≠</div><div>No messages yet</div></div>';
                    return;
                }
                
                messagesContent.innerHTML = '';
                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const messageCard = createMessageCard(docSnap.id, data);
                    messagesContent.appendChild(messageCard);
                });
            });
        }

        function createMessageCard(id, data) {
            const card = document.createElement('div');
            card.className = 'card';
            
            const timestamp = data.timestamp?.toDate();
            const formattedTime = timestamp 
                ? new Intl.DateTimeFormat('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }).format(timestamp)
                : 'No date';
            
            card.innerHTML = `
                <div class="card-header">
                    <div>
                        <div style="font-weight: 600; font-size: 18px; margin-bottom: 5px;">${escapeHtml(data.name || 'Unknown')}</div>
                        <div style="color: #718096; font-size: 14px;">${escapeHtml(data.email || 'No email')}</div>
                    </div>
                    <div style="color: #718096; font-size: 13px;">${formattedTime}</div>
                </div>
                <div style="margin-bottom: 15px;">
                    <div style="font-weight: 600; margin-bottom: 8px;">Subject: ${escapeHtml(data.subject || 'No subject')}</div>
                    <div style="line-height: 1.6;">${escapeHtml(data.message || 'No message')}</div>
                </div>
                <button class="btn btn-danger" onclick="deleteMessage('${id}')">Delete</button>
            `;
            
            return card;
        }

        window.deleteMessage = async function(messageId) {
            if (confirm('Delete this message?')) {
                try {
                    await deleteDoc(doc(db, 'messages', messageId));
                } catch (error) {
                    alert('Error deleting message: ' + error.message);
                }
            }
        };

        // ===== BUDGET CALCULATORS =====
        
        window.calculateSavings = function() {
            const initial = parseFloat(document.getElementById('savingsInitial').value) || 0;
            const monthly = parseFloat(document.getElementById('savingsMonthly').value) || 0;
            const rate = parseFloat(document.getElementById('savingsRate').value) || 0;
            const years = parseInt(document.getElementById('savingsYears').value) || 0;
            
            const months = years * 12;
            const monthlyRate = rate / 100 / 12;
            
            // Future value with compound interest
            let futureValue = initial * Math.pow(1 + monthlyRate, months);
            
            // Add monthly contributions
            if (monthlyRate > 0) {
                futureValue += monthly * ((Math.pow(1 + monthlyRate, months) - 1) / monthlyRate);
            } else {
                futureValue += monthly * months;
            }
            
            const totalContributions = initial + (monthly * months);
            const interestEarned = futureValue - totalContributions;
            
            const resultDiv = document.getElementById('savingsResult');
            const resultText = document.getElementById('savingsResultText');
            
            resultText.innerHTML = `
                <div style="margin-bottom: 8px;"><strong>Future Value:</strong> GH‚Çµ ${futureValue.toFixed(2)}</div>
                <div style="margin-bottom: 8px;"><strong>Total Contributions:</strong> GH‚Çµ ${totalContributions.toFixed(2)}</div>
                <div style="margin-bottom: 8px;"><strong>Interest Earned:</strong> GH‚Çµ ${interestEarned.toFixed(2)}</div>
                <div style="color: #059669; font-weight: 600;">Return on Investment: ${((interestEarned / totalContributions) * 100).toFixed(1)}%</div>
            `;
            
            resultDiv.style.display = 'block';
        };
        
        window.calculateLoan = function() {
            const amount = parseFloat(document.getElementById('loanAmount').value) || 0;
            const rate = parseFloat(document.getElementById('loanRate').value) || 0;
            const months = parseInt(document.getElementById('loanMonths').value) || 0;
            
            const monthlyRate = rate / 100 / 12;
            
            // Monthly payment using amortization formula
            let monthlyPayment = 0;
            if (monthlyRate > 0) {
                monthlyPayment = amount * (monthlyRate * Math.pow(1 + monthlyRate, months)) / (Math.pow(1 + monthlyRate, months) - 1);
            } else {
                monthlyPayment = amount / months;
            }
            
            const totalPayment = monthlyPayment * months;
            const totalInterest = totalPayment - amount;
            
            const resultDiv = document.getElementById('loanResult');
            const resultText = document.getElementById('loanResultText');
            
            resultText.innerHTML = `
                <div style="margin-bottom: 8px;"><strong>Monthly Payment:</strong> GH‚Çµ ${monthlyPayment.toFixed(2)}</div>
                <div style="margin-bottom: 8px;"><strong>Total Payment:</strong> GH‚Çµ ${totalPayment.toFixed(2)}</div>
                <div style="margin-bottom: 8px;"><strong>Total Interest:</strong> GH‚Çµ ${totalInterest.toFixed(2)}</div>
                <div style="color: #b45309; font-weight: 600;">Interest as % of Loan: ${((totalInterest / amount) * 100).toFixed(1)}%</div>
            `;
            
            resultDiv.style.display = 'block';
        };
        
        window.calculateInvestment = function() {
            const initial = parseFloat(document.getElementById('investAmount').value) || 0;
            const returnRate = parseFloat(document.getElementById('investReturn').value) || 0;
            const years = parseInt(document.getElementById('investYears').value) || 0;
            const annual = parseFloat(document.getElementById('investAnnual').value) || 0;
            
            const rate = returnRate / 100;
            
            let futureValue = initial * Math.pow(1 + rate, years);
            
            // Add annual contributions
            for (let i = 1; i <= years; i++) {
                futureValue += annual * Math.pow(1 + rate, years - i);
            }
            
            const totalInvested = initial + (annual * years);
            const totalGains = futureValue - totalInvested;
            
            const resultDiv = document.getElementById('investResult');
            const resultText = document.getElementById('investResultText');
            
            resultText.innerHTML = `
                <div style="margin-bottom: 8px;"><strong>Future Value:</strong> GH‚Çµ ${futureValue.toFixed(2)}</div>
                <div style="margin-bottom: 8px;"><strong>Total Invested:</strong> GH‚Çµ ${totalInvested.toFixed(2)}</div>
                <div style="margin-bottom: 8px;"><strong>Investment Gains:</strong> GH‚Çµ ${totalGains.toFixed(2)}</div>
                <div style="color: #047857; font-weight: 600;">ROI: ${((totalGains / totalInvested) * 100).toFixed(1)}%</div>
            `;
            
            resultDiv.style.display = 'block';
        };
        
        window.calculateBudgetRule = function() {
            const income = parseFloat(document.getElementById('budgetIncome').value) || 0;
            
            const needs = income * 0.50;
            const wants = income * 0.30;
            const savings = income * 0.20;
            
            const resultDiv = document.getElementById('budgetRuleResult');
            const resultText = document.getElementById('budgetRuleText');
            
            resultText.innerHTML = `
                <div style="margin-bottom: 8px;"><strong>Needs (50%):</strong> GH‚Çµ ${needs.toFixed(2)}</div>
                <div style="font-size: 13px; color: #6b7280; margin-bottom: 12px; padding-left: 15px;">Housing, utilities, groceries, transportation, insurance</div>
                <div style="margin-bottom: 8px;"><strong>Wants (30%):</strong> GH‚Çµ ${wants.toFixed(2)}</div>
                <div style="font-size: 13px; color: #6b7280; margin-bottom: 12px; padding-left: 15px;">Entertainment, dining out, hobbies, subscriptions</div>
                <div style="margin-bottom: 8px;"><strong>Savings (20%):</strong> GH‚Çµ ${savings.toFixed(2)}</div>
                <div style="font-size: 13px; color: #6b7280; padding-left: 15px;">Emergency fund, retirement, investments, debt repayment</div>
            `;
            
            resultDiv.style.display = 'block';
        };
        
        window.calculateEmergencyFund = function() {
            const expenses = parseFloat(document.getElementById('emergencyExpenses').value) || 0;
            const months = parseInt(document.getElementById('emergencyMonths').value) || 0;
            const current = parseFloat(document.getElementById('emergencySavings').value) || 0;
            
            const target = expenses * months;
            const remaining = target - current;
            const progress = (current / target) * 100;
            
            const resultDiv = document.getElementById('emergencyResult');
            const resultText = document.getElementById('emergencyResultText');
            
            let statusMessage = '';
            if (remaining <= 0) {
                statusMessage = '<div style="color: #059669; font-weight: 600; margin-top: 10px;">‚úì You have met your emergency fund goal!</div>';
            } else {
                statusMessage = `<div style="color: #dc2626; font-weight: 600; margin-top: 10px;">You need GH‚Çµ ${remaining.toFixed(2)} more to reach your goal.</div>`;
            }
            
            resultText.innerHTML = `
                <div style="margin-bottom: 8px;"><strong>Target Emergency Fund:</strong> GH‚Çµ ${target.toFixed(2)}</div>
                <div style="margin-bottom: 8px;"><strong>Current Savings:</strong> GH‚Çµ ${current.toFixed(2)}</div>
                <div style="margin-bottom: 8px;"><strong>Progress:</strong> ${progress.toFixed(1)}%</div>
                ${statusMessage}
            `;
            
            resultDiv.style.display = 'block';
        };
        
        window.calculateTax = function() {
            const income = parseFloat(document.getElementById('taxIncome').value) || 0;
            
            // Ghana tax brackets (simplified - 2024 rates)
            let tax = 0;
            
            if (income <= 4380) {
                tax = 0; // First GH‚Çµ 4,380 is tax-free
            } else if (income <= 6380) {
                tax = (income - 4380) * 0.05; // 5% on next GH‚Çµ 2,000
            } else if (income <= 10380) {
                tax = 100 + (income - 6380) * 0.10; // 10% on next GH‚Çµ 4,000
            } else if (income <= 45380) {
                tax = 500 + (income - 10380) * 0.175; // 17.5% on next GH‚Çµ 35,000
            } else if (income <= 120380) {
                tax = 6625 + (income - 45380) * 0.25; // 25% on next GH‚Çµ 75,000
            } else {
                tax = 25375 + (income - 120380) * 0.30; // 30% on amount over GH‚Çµ 120,380
            }
            
            const netIncome = income - tax;
            const effectiveRate = (tax / income) * 100;
            const monthlyNet = netIncome / 12;
            
            const resultDiv = document.getElementById('taxResult');
            const resultText = document.getElementById('taxResultText');
            
            resultText.innerHTML = `
                <div style="margin-bottom: 8px;"><strong>Annual Income:</strong> GH‚Çµ ${income.toFixed(2)}</div>
                <div style="margin-bottom: 8px;"><strong>Income Tax:</strong> GH‚Çµ ${tax.toFixed(2)}</div>
                <div style="margin-bottom: 8px;"><strong>Net Annual Income:</strong> GH‚Çµ ${netIncome.toFixed(2)}</div>
                <div style="margin-bottom: 8px;"><strong>Monthly Net Income:</strong> GH‚Çµ ${monthlyNet.toFixed(2)}</div>
                <div style="color: #0e7490; font-weight: 600;">Effective Tax Rate: ${effectiveRate.toFixed(2)}%</div>
            `;
            
            resultDiv.style.display = 'block';
        };

        // ===== MEAL PLANNER =====
        function initializeMealPlanner() {
            const q = query(
                collection(db, 'mealPlans'),
                where('userId', '==', currentUser.uid),
                orderBy('date', 'desc')
            );

            onSnapshot(q, (snapshot) => {
                mealPlans = [];
                snapshot.forEach((docSnap) => {
                    mealPlans.push({ id: docSnap.id, ...docSnap.data() });
                });
                if (!mealPlansLoaded) {
                    mealPlansLoaded = true;
                    if (pendingMealPlannerOpen) {
                        pendingMealPlannerOpen = false;
                        onMealPlannerOpen();
                    }
                }
                displayMealPlans();
            });
        }

        async function onMealPlannerOpen() {
            if (!mealPlansLoaded) {
                pendingMealPlannerOpen = true;
                return;
            }
            if (autoMealPlanGenerated) return;
            autoMealPlanGenerated = true;
            const today = new Date().toISOString().split('T')[0];
            const existingPlan = mealPlans.find(p => p.date === today);
            if (existingPlan) {
                const todayDiv = document.getElementById('todayMealPlan');
                todayDiv.innerHTML = `<div class="ai-message-content" style="line-height: 1.9;">${formatAIResponse(existingPlan.plan)}</div>`;
                displayMealPlans();
            } else {
                await generateMealPlan(today, false);
            }
        }

        window.regenerateTodayMealPlan = async function() {
            const today = new Date().toISOString().split('T')[0];
            await generateMealPlan(today, true);
        };

        async function generateMealPlan(date, isRegenerate) {
            const todayDiv = document.getElementById('todayMealPlan');
            todayDiv.innerHTML = '<div class="loading">ü§ñ AI is planning your meals for the day‚Ä¶</div>';

            const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const budgetRemaining = MONTHLY_BUDGET - totalExpenses;

            const foodExpenses = transactions.filter(t => t.type === 'expense' && t.category === 'Food');
            const now = new Date();
            const daysElapsed = Math.max(1, now.getDate());
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            const totalFoodSpent = foodExpenses.reduce((sum, t) => sum + t.amount, 0);
            const avgDailyFoodBudget = foodExpenses.length > 0
                ? (totalFoodSpent / daysElapsed).toFixed(2)
                : (budgetRemaining / (daysInMonth - daysElapsed + 1)).toFixed(2);

            // Build a list of recent food transactions so the AI sees real price levels
            const recentFoodTx = foodExpenses
                .slice(0, 10)
                .map(t => `  ‚Ä¢ ${t.date}: ${escapeHtml(t.description || t.category)} ‚Äî GH‚Çµ ${t.amount}`)
                .join('\n');

            const previousMealsSummary = mealPlans
                .filter(p => p.date !== date)
                .slice(0, 5)
                .map(p => `${p.date}: ${p.summary || '(meal plan)'}`)
                .join('\n');

            const prompt = `As a nutritionist and financial advisor for Francis in Ghana, create a detailed meal plan for ${date}.

Financial Context:
- Monthly Budget Remaining: GH‚Çµ ${budgetRemaining}
- Estimated Daily Food Budget: GH‚Çµ ${avgDailyFoodBudget} (based on GH‚Çµ ${totalFoodSpent} spent on food over ${daysElapsed} days)
- Monthly Income: GH‚Çµ ${totalIncome}
${recentFoodTx ? `\nFrancis's actual recent food expenses (use these as your price reference ‚Äî do NOT suggest prices lower than what he actually pays):\n${recentFoodTx}\n` : ''}${previousMealsSummary ? `\nRecent meal history (for variety):\n${previousMealsSummary}\n` : ''}
Please create a balanced daily meal plan that:
1. Stays within the daily food budget
2. Is nutritionally balanced (carbs, protein, vegetables)
3. Uses locally available Ghanaian foods/ingredients
4. Provides variety compared to recent meals

IMPORTANT: Use realistic 2024 Ghana market prices. A bottle of water alone costs at least GH‚Çµ 2‚Äì3. A simple street meal starts at GH‚Çµ 15‚Äì25. Do NOT suggest any per-meal cost below GH‚Çµ 10. Base your prices on the actual food expenses listed above.

Format your response as:
**Breakfast**: (meal description) ‚Äî GH‚Çµ X
**Lunch**: (meal description) ‚Äî GH‚Çµ X
**Dinner**: (meal description) ‚Äî GH‚Çµ X
**Snack** (optional): (description) ‚Äî GH‚Çµ X
**Total Estimated Cost**: GH‚Çµ X
**Nutritional Notes**: (brief note on balance)`;

            try {
                const response = await callGeminiAPI(prompt);

                // Build a short summary: prefer a line mentioning Breakfast/Lunch/Dinner, else first non-empty line
                const lines = response.split('\n').map(l => l.replace(/\*\*/g, '').trim()).filter(l => l.length > 0);
                const mealLine = lines.find(l => /breakfast|lunch|dinner/i.test(l)) || lines[0] || '';
                const summary = mealLine.length > 130 ? mealLine.substring(0, 130).replace(/\s+\S*$/, '‚Ä¶') : mealLine;

                const existingPlan = mealPlans.find(p => p.date === date);
                if (existingPlan && isRegenerate) {
                    await updateDoc(doc(db, 'mealPlans', existingPlan.id), {
                        plan: response,
                        summary,
                        generatedAt: serverTimestamp()
                    });
                } else if (!existingPlan) {
                    await addDoc(collection(db, 'mealPlans'), {
                        date,
                        plan: response,
                        summary,
                        timestamp: serverTimestamp(),
                        generatedAt: serverTimestamp(),
                        userId: currentUser.uid
                    });
                }

                todayDiv.innerHTML = `<div class="ai-message-content" style="line-height: 1.9;">${formatAIResponse(response)}</div>`;
            } catch (error) {
                todayDiv.innerHTML = `<div style="color: #ef4444;">Error generating meal plan: ${error.message}</div>`;
            }
        }

        function displayMealPlans() {
            const today = new Date().toISOString().split('T')[0];
            const todayPlan = mealPlans.find(p => p.date === today);
            const todayDiv = document.getElementById('todayMealPlan');

            if (todayPlan && todayDiv && !todayDiv.innerHTML.includes('AI is planning')) {
                todayDiv.innerHTML = `<div class="ai-message-content" style="line-height: 1.9;">${formatAIResponse(todayPlan.plan)}</div>`;
            }

            const historyDiv = document.getElementById('mealPlanHistory');
            if (!historyDiv) return;

            const previousPlans = mealPlans.filter(p => p.date !== today);
            if (previousPlans.length === 0) {
                historyDiv.innerHTML = '<div class="empty-state"><div class="empty-icon">üçΩÔ∏è</div><div>No previous meal plans yet. Come back tomorrow!</div></div>';
                return;
            }

            historyDiv.innerHTML = previousPlans.map(plan => `
                <div style="padding: 18px; border: 1px solid #e2e8f0; border-radius: 10px; margin-bottom: 15px;">
                    <div style="font-weight: 700; margin-bottom: 12px; color: #4a5568; font-size: 15px;">üìÖ ${plan.date}</div>
                    <div class="ai-message-content" style="line-height: 1.9;">${formatAIResponse(plan.plan)}</div>
                </div>
            `).join('');
        }

        // ===== AI ASSISTANT =====
        let chatMessages = [];

        function initializeAI() {
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');

            if (chatMessages.length === 0) {
                addChatMessage({
                    text: `Hello Francis! üëã I'm your AI assistant. I can help you with finances, planning, productivity, and more. What can I do for you today?`,
                    isUser: false,
                    timestamp: new Date()
                });
            }

            sendBtn.addEventListener('click', sendChatMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                }
            });
        }

        async function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const text = chatInput.value.trim();
            if (!text) return;

            chatInput.value = '';

            addChatMessage({
                text: text,
                isUser: true,
                timestamp: new Date()
            });

            try {
                const response = await callGeminiAPI(text);
                addChatMessage({
                    text: response,
                    isUser: false,
                    timestamp: new Date()
                });
            } catch (error) {
                addChatMessage({
                    text: `Sorry, I encountered an error: ${error.message}`,
                    isUser: false,
                    timestamp: new Date()
                });
            }
        }

        function addChatMessage(message) {
            chatMessages.push(message);
            
            const chatMessagesDiv = document.getElementById('chatMessages');
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${message.isUser ? 'user' : 'ai'}`;
            
            const time = new Intl.DateTimeFormat('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            }).format(message.timestamp);
            
            // Format the message text for AI responses
            const formattedText = message.isUser ? escapeHtml(message.text) : formatAIResponse(message.text);
            
            bubble.innerHTML = `
                <div class="chat-avatar ${message.isUser ? 'user' : 'ai'}">
                    ${message.isUser ? 'üë§' : 'ü§ñ'}
                </div>
                <div class="chat-content">
                    <div class="ai-message-content">${formattedText}</div>
                    <div style="font-size: 11px; opacity: 0.7; margin-top: 5px;">${time}</div>
                </div>
            `;
            
            chatMessagesDiv.appendChild(bubble);
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }
        
        function formatAIResponse(text) {
            // Escape HTML first
            let formatted = escapeHtml(text);
            
            // Convert line breaks to <br> first
            formatted = formatted.replace(/\n/g, '<br>');
            
            // Convert ### and ## Headings to styled headings (before other formatting)
            formatted = formatted.replace(/###\s+(.+?)(?:<br>|$)/g, '<h3 style="font-size: 18px; font-weight: 700; margin-top: 15px; margin-bottom: 10px; color: #0f172a;">$1</h3>');
            formatted = formatted.replace(/##\s+(.+?)(?:<br>|$)/g, '<h2 style="font-size: 20px; font-weight: 700; margin-top: 15px; margin-bottom: 10px; color: #0f172a;">$1</h2>');
            
            // Convert code blocks `code` (before other inline formatting)
            formatted = formatted.replace(/`(.+?)`/g, '<code style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 13px;">$1</code>');
            
            // Convert numbered lists (1. item) - process before asterisk formatting
            formatted = formatted.replace(/^(\d+)\.\s+(.+)$/gm, '<div style="margin-left: 20px; margin-bottom: 8px;"><strong>$1.</strong> $2</div>');
            
            // Convert bullet points starting with dash (- item)
            formatted = formatted.replace(/^-\s+(.+)$/gm, '<div style="margin-left: 20px; margin-bottom: 8px;">‚Ä¢ $1</div>');
            
            // Convert **bold** to <strong> (before italic to avoid conflicts)
            formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            
            // Convert *italic* to <em> (after bold)
            formatted = formatted.replace(/\*([^*]+?)\*/g, '<em>$1</em>');
            
            // Convert URLs to clickable links (handle parentheses in URLs while excluding trailing punctuation)
            formatted = formatted.replace(
                /(https?:\/\/[^\s<>"]+?)([.,;!?]*)(?=\s|<|$)/g,
                function(match, url, trailing) {
                    // If URL ends with closing paren and trailing has punctuation, check if it's part of URL
                    if (url.endsWith(')') && trailing) {
                        // Count parentheses in URL
                        const openParens = (url.match(/\(/g) || []).length;
                        const closeParens = (url.match(/\)/g) || []).length;
                        // If balanced, keep the closing paren
                        if (openParens === closeParens) {
                            return `<a href="${url}" target="_blank" rel="noopener noreferrer" style="color: #4f46e5; text-decoration: underline;">${url}</a>${trailing}`;
                        }
                    }
                    return `<a href="${url}" target="_blank" rel="noopener noreferrer" style="color: #4f46e5; text-decoration: underline;">${url}</a>${trailing}`;
                }
            );
            
            return formatted;
        }

        async function callGeminiAPI(userMessage) {
            try {
                // Generates content using the Gemini 2.0 Flash model
                const result = await model.generateContent(userMessage);
                const response = await result.response;
                const text = response.text();
                return text;
            } catch (error) {
                console.error("Vertex AI Error:", error);
                throw new Error("I'm having trouble connecting to my brain. Please check your internet connection or try again later.");
            }
        }

        // ===== DASHBOARD =====
        function updateDashboard() {
            const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const activeTasks = tasks.filter(t => !t.completed).length;
            
            document.getElementById('dashTotalExpenses').textContent = `GH‚Çµ ${totalExpenses.toFixed(2)}`;
            document.getElementById('dashMonthlyBudget').textContent = `GH‚Çµ ${(MONTHLY_BUDGET - totalExpenses).toFixed(2)}`;
            document.getElementById('dashActiveTasks').textContent = activeTasks;
            document.getElementById('dashBlogCount').textContent = blogs.length;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        window.firebaseApp = app;
    </script>
</body>

</html>
