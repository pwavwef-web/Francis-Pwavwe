<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Francis Admin Panel</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background: #f5f5f5;
        }

        /* Login Screen Styles */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1E3A8A 0%, #3B82F6 100%);
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 400px;
            margin: 20px;
        }

        .login-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: #1E3A8A;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 40px;
        }

        .login-title {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .login-subtitle {
            text-align: center;
            font-size: 14px;
            color: #666;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #1E3A8A;
        }

        .error-message {
            color: #dc2626;
            font-size: 14px;
            margin-top: 20px;
            text-align: center;
            padding: 10px;
            background: #fee2e2;
            border-radius: 6px;
        }

        .btn-primary {
            width: 100%;
            padding: 15px;
            background: #1E3A8A;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-primary:hover:not(:disabled) {
            background: #1e40af;
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .spinner {
            border: 2px solid white;
            border-top: 2px solid transparent;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Dashboard Styles */
        .dashboard {
            display: none;
            min-height: 100vh;
        }

        .dashboard.active {
            display: flex;
            flex-direction: column;
        }

        .app-header {
            background: #1E3A8A;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .app-title {
            font-size: 20px;
            font-weight: 600;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .dashboard-content {
            display: flex;
            flex: 1;
        }

        .sidebar {
            width: 200px;
            background: #f5f5f5;
            border-right: 1px solid #e5e5e5;
            padding: 20px 0;
        }

        .nav-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #666;
        }

        .nav-item:hover {
            background: #e5e5e5;
        }

        .nav-item.active {
            background: #1E3A8A;
            color: white;
            font-weight: 600;
        }

        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* Messages Screen Styles */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .message-card {
            background: white;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .message-header {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .message-header:hover {
            background: #f9f9f9;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #1E3A8A;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .message-info {
            flex: 1;
        }

        .message-name {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .message-email {
            font-size: 14px;
            color: #666;
        }

        .message-date {
            font-size: 12px;
            color: #999;
        }

        .message-expand-icon {
            transition: transform 0.3s;
        }

        .message-expand-icon.expanded {
            transform: rotate(180deg);
        }

        .message-details {
            padding: 0 20px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s, padding 0.3s;
        }

        .message-details.expanded {
            max-height: 500px;
            padding: 0 20px 20px;
        }

        .message-subject {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .message-text {
            color: #333;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .delete-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .delete-btn:hover {
            background: #b91c1c;
        }

        /* AI Assistant Styles */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 120px);
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .chat-message {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .chat-message.user {
            flex-direction: row-reverse;
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            flex-shrink: 0;
        }

        .chat-avatar.ai {
            background: #1E3A8A;
        }

        .chat-avatar.user {
            background: #D4AF37;
        }

        .chat-bubble {
            padding: 15px;
            border-radius: 15px;
            max-width: 70%;
        }

        .chat-bubble.ai {
            background: #f5f5f5;
            color: #333;
        }

        .chat-bubble.user {
            background: #1E3A8A;
            color: white;
        }

        .chat-text {
            margin-bottom: 5px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .chat-time {
            font-size: 10px;
            opacity: 0.7;
        }

        .chat-loading {
            display: none;
            padding: 8px 20px;
            align-items: center;
            gap: 10px;
        }

        .chat-loading.active {
            display: flex;
        }

        .chat-loading .spinner {
            border-color: #1E3A8A;
            border-top-color: transparent;
        }

        .chat-input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e5e5e5;
            box-shadow: 0 -5px 10px rgba(0, 0, 0, 0.05);
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            resize: vertical;
            min-height: 50px;
            max-height: 150px;
            font-family: inherit;
        }

        .chat-input:focus {
            outline: none;
            border-color: #1E3A8A;
        }

        .send-btn {
            background: #1E3A8A;
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 20px;
            transition: background 0.3s;
        }

        .send-btn:hover:not(:disabled) {
            background: #1e40af;
        }

        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1E3A8A;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        .hidden {
            display: none !important;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e5e5e5;
                padding: 10px 0;
                display: flex;
            }

            .nav-item {
                flex: 1;
                text-align: center;
                padding: 10px;
            }

            .dashboard-content {
                flex-direction: column;
            }

            .chat-bubble {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-container hidden">
        <div class="login-card">
            <div class="login-icon">ðŸ”’</div>
            <h1 class="login-title">Francis Admin Panel</h1>
            <p class="login-subtitle">Restricted Access</p>
            
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label" for="email">Email</label>
                    <input 
                        type="email" 
                        id="email" 
                        class="form-input" 
                        placeholder="Enter your email"
                        required
                    >
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="password">Password</label>
                    <input 
                        type="password" 
                        id="password" 
                        class="form-input" 
                        placeholder="Enter your password"
                        required
                    >
                </div>
                
                <div id="errorMessage" class="error-message hidden"></div>
                
                <button type="submit" id="loginBtn" class="btn-primary">
                    <span id="loginBtnText">Sign In</span>
                    <div id="loginSpinner" class="spinner hidden"></div>
                </button>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="dashboard" class="dashboard">
        <header class="app-header">
            <h1 class="app-title">Francis Admin Panel</h1>
            <button id="logoutBtn" class="logout-btn">Sign Out</button>
        </header>
        
        <div class="dashboard-content">
            <nav class="sidebar">
                <div class="nav-item active" data-screen="messages">
                    <span>ðŸ“§</span>
                    <span>Messages</span>
                </div>
                <div class="nav-item" data-screen="ai-assistant">
                    <span>ðŸ¤–</span>
                    <span>AI Assistant</span>
                </div>
            </nav>
            
            <main class="main-content">
                <!-- Messages Screen -->
                <div id="messagesScreen" class="screen active">
                    <div id="messagesContainer"></div>
                </div>
                
                <!-- AI Assistant Screen -->
                <div id="aiAssistantScreen" class="screen">
                    <div class="chat-container">
                        <div class="chat-messages" id="chatMessages"></div>
                        <div class="chat-loading" id="chatLoading">
                            <div class="spinner"></div>
                            <span>AI is thinking...</span>
                        </div>
                        <div class="chat-input-area">
                            <div class="chat-input-container">
                                <textarea 
                                    id="chatInput" 
                                    class="chat-input" 
                                    placeholder="Ask about finances, budgeting, diet, planning..."
                                    rows="1"
                                ></textarea>
                                <button id="sendBtn" class="send-btn">âž¤</button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Fallback script to show login screen if Firebase fails -->
    <script>
        // Fallback to show login screen if Firebase fails to load or takes too long
        setTimeout(() => {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay && !loadingOverlay.classList.contains('hidden')) {
                loadingOverlay.classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
            }
        }, 3000);
    </script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, orderBy, onSnapshot, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB6lxgjNY4CRNHAe3pAgR5SYv1ohL8brOI",
            authDomain: "francis-pwavwe.firebaseapp.com",
            projectId: "francis-pwavwe",
            storageBucket: "francis-pwavwe.firebasestorage.app",
            messagingSenderId: "658069378543",
            appId: "1:658069378543:web:87b1dcb0dd27d3255bd21a"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM elements
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loginScreen = document.getElementById('loginScreen');
        const dashboard = document.getElementById('dashboard');
        const loginForm = document.getElementById('loginForm');
        const loginBtn = document.getElementById('loginBtn');
        const loginBtnText = document.getElementById('loginBtnText');
        const loginSpinner = document.getElementById('loginSpinner');
        const errorMessage = document.getElementById('errorMessage');
        const logoutBtn = document.getElementById('logoutBtn');
        const navItems = document.querySelectorAll('.nav-item');
        const screens = document.querySelectorAll('.screen');
        const messagesContainer = document.getElementById('messagesContainer');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const chatLoading = document.getElementById('chatLoading');

        // Gemini API Key (same as in francis.dart)
        const GEMINI_API_KEY = 'AIzaSyDcEcBXUuzBas3qAaSQ-zw1a7Tj20guvwk';
        const AUTHORIZED_EMAIL = 'pwavwef@gmail.com';

        // Chat history
        let chatHistory = [];

        // Auth state observer
        onAuthStateChanged(auth, (user) => {
            loadingOverlay.classList.add('hidden');
            
            if (user && user.email === AUTHORIZED_EMAIL) {
                loginScreen.classList.add('hidden');
                dashboard.classList.add('active');
                loadMessages();
                initializeAIAssistant();
            } else {
                if (user && user.email !== AUTHORIZED_EMAIL) {
                    signOut(auth);
                }
                loginScreen.classList.remove('hidden');
                dashboard.classList.remove('active');
            }
        });

        // Login form handler
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            // Check if email is authorized
            if (email !== AUTHORIZED_EMAIL) {
                showError('Access denied. This panel is restricted to Francis Pwavwe only.');
                return;
            }
            
            setLoading(true);
            errorMessage.classList.add('hidden');
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showError(error.message || 'Authentication failed');
                setLoading(false);
            }
        });

        // Logout handler
        logoutBtn.addEventListener('click', async () => {
            await signOut(auth);
        });

        // Navigation handler
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const screenName = item.dataset.screen;
                
                // Update active nav item
                navItems.forEach(nav => nav.classList.remove('active'));
                item.classList.add('active');
                
                // Update active screen
                screens.forEach(screen => screen.classList.remove('active'));
                document.getElementById(`${screenName}Screen`).classList.add('active');
            });
        });

        // Load messages from Firestore
        function loadMessages() {
            const q = query(collection(db, 'messages'), orderBy('timestamp', 'desc'));
            
            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    messagesContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ðŸ“­</div>
                            <p style="font-size: 18px; color: #666;">No messages yet</p>
                        </div>
                    `;
                    return;
                }
                
                messagesContainer.innerHTML = '';
                
                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const messageCard = createMessageCard(docSnap.id, data);
                    messagesContainer.appendChild(messageCard);
                });
            }, (error) => {
                console.error('Error loading messages:', error);
                messagesContainer.innerHTML = `
                    <div class="empty-state">
                        <p style="color: #dc2626;">Error loading messages: ${error.message}</p>
                    </div>
                `;
            });
        }

        // Create message card element
        function createMessageCard(id, data) {
            const card = document.createElement('div');
            card.className = 'message-card';
            
            const name = data.name || 'Unknown';
            const email = data.email || 'No email';
            const subject = data.subject || 'No subject';
            const message = data.message || 'No message';
            const timestamp = data.timestamp?.toDate();
            const dateStr = timestamp ? new Date(timestamp).toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }) : '';
            
            card.innerHTML = `
                <div class="message-header" onclick="toggleMessage(this)">
                    <div class="message-avatar">${name[0].toUpperCase()}</div>
                    <div class="message-info">
                        <div class="message-name">${name}</div>
                        <div class="message-email">${email}</div>
                        ${dateStr ? `<div class="message-date">${dateStr}</div>` : ''}
                    </div>
                    <div class="message-expand-icon">â–¼</div>
                </div>
                <div class="message-details">
                    <div class="message-subject">Subject: ${subject}</div>
                    <div class="message-text">${message}</div>
                    <button class="delete-btn" onclick="deleteMessage('${id}', event)">Delete</button>
                </div>
            `;
            
            return card;
        }

        // Toggle message details
        window.toggleMessage = function(header) {
            const details = header.nextElementSibling;
            const icon = header.querySelector('.message-expand-icon');
            
            details.classList.toggle('expanded');
            icon.classList.toggle('expanded');
        };

        // Delete message
        window.deleteMessage = async function(id, event) {
            event.stopPropagation();
            
            if (confirm('Are you sure you want to delete this message?')) {
                try {
                    await deleteDoc(doc(db, 'messages', id));
                } catch (error) {
                    alert('Error deleting message: ' + error.message);
                }
            }
        };

        // Initialize AI Assistant with welcome message
        function initializeAIAssistant() {
            const welcomeMessage = {
                text: `Hello Francis! I'm your AI assistant. I can help you with:

ðŸ’° Financial planning and budgeting
ðŸ’³ Expense tracking and spending analysis
ðŸ“Š Budget optimization
ðŸ“… Financial goal planning
ðŸ¥— Dietary advice and meal planning
ðŸŽ¯ Personal productivity tips

How can I assist you today?`,
                isUser: false,
                timestamp: new Date()
            };
            
            chatHistory = [welcomeMessage];
            displayChatMessage(welcomeMessage);
        }

        // Display chat message
        function displayChatMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${message.isUser ? 'user' : 'ai'}`;
            
            const time = message.timestamp.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            messageDiv.innerHTML = `
                <div class="chat-avatar ${message.isUser ? 'user' : 'ai'}">
                    ${message.isUser ? 'ðŸ‘¤' : 'ðŸ¤–'}
                </div>
                <div class="chat-bubble ${message.isUser ? 'user' : 'ai'}">
                    <div class="chat-text">${message.text}</div>
                    <div class="chat-time">${time}</div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Send message to AI
        async function sendMessageToAI() {
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;
            
            // Add user message
            const userMsg = {
                text: userMessage,
                isUser: true,
                timestamp: new Date()
            };
            chatHistory.push(userMsg);
            displayChatMessage(userMsg);
            
            // Clear input
            chatInput.value = '';
            chatInput.style.height = 'auto';
            
            // Show loading
            chatLoading.classList.add('active');
            sendBtn.disabled = true;
            
            try {
                // Create context-aware prompt
                const prompt = `You are a personal AI assistant for Francis Pwavwe. You specialize in:
1. Financial planning, budgeting, and spending management
2. Personal finance advice tailored to a student/young professional
3. Dietary and nutrition advice
4. Personal productivity and planning

User's question: ${userMessage}

Provide helpful, practical, and personalized advice. Be concise but thorough.`;

                // Call Gemini API
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: prompt
                                }]
                            }]
                        })
                    }
                );
                
                const data = await response.json();
                
                let aiText = "Sorry, I couldn't generate a response.";
                if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
                    aiText = data.candidates[0].content.parts[0].text;
                }
                
                // Add AI response
                const aiMsg = {
                    text: aiText,
                    isUser: false,
                    timestamp: new Date()
                };
                chatHistory.push(aiMsg);
                displayChatMessage(aiMsg);
                
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                const errorMsg = {
                    text: `Sorry, I encountered an error: ${error.message}`,
                    isUser: false,
                    timestamp: new Date()
                };
                chatHistory.push(errorMsg);
                displayChatMessage(errorMsg);
            } finally {
                chatLoading.classList.remove('active');
                sendBtn.disabled = false;
            }
        }

        // Chat input handlers
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessageToAI();
            }
        });

        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });

        sendBtn.addEventListener('click', sendMessageToAI);

        // Helper functions
        function setLoading(isLoading) {
            loginBtn.disabled = isLoading;
            loginBtnText.classList.toggle('hidden', isLoading);
            loginSpinner.classList.toggle('hidden', !isLoading);
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }
    </script>
</body>
</html>
